# 会话服务集成

<cite>
**本文档引用的文件**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts)
- [v1-conversation-service.types.ts](file://frontend/src/api/conversation-service/v1-conversation-service.types.ts)
- [conversation-service.api.ts](file://frontend/src/api/conversation-service/conversation-service.api.ts)
- [conversation-status.ts](file://frontend/src/types/conversation-status.ts)
- [conversation.py](file://openhands/server/routes/conversation.py)
- [manage_conversations.py](file://openhands/server/routes/manage_conversations.py)
- [conversation_info.py](file://openhands/server/data_models/conversation_info.py)
- [live_status_app_conversation_service.py](file://openhands/app_server/app_conversation/live_status_app_conversation_service.py)
</cite>

## 目录
1. [简介](#简介)
2. [会话服务API概览](#会话服务api概览)
3. [核心操作](#核心操作)
4. [数据模型与类型约束](#数据模型与类型约束)
5. [版本化API设计原则](#版本化api设计原则)
6. [实际调用示例](#实际调用示例)
7. [错误恢复机制](#错误恢复机制)
8. [最佳实践](#最佳实践)

## 简介

会话服务是OpenHands平台的核心组件，负责管理AI代理的会话生命周期。本文档详细描述了前端如何通过ConversationService API与后端进行交互，重点涵盖会话创建、启动、停止、状态查询等核心操作的请求/响应模式。文档还深入解析了v1-conversation-service.types.ts中定义的数据模型和类型约束，以及版本化API的设计原则。

会话服务支持两种版本的API：V0（传统）和V1（新版本）。V1 API提供了更丰富的功能和更好的性能，包括实时状态更新、更细粒度的控制和更灵活的配置选项。前端应用需要根据会话版本选择相应的API进行调用。

**Section sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L1-L294)
- [conversation-service.api.ts](file://frontend/src/api/conversation-service/conversation-service.api.ts#L1-L398)

## 会话服务API概览

会话服务API提供了丰富的端点来管理AI代理会话。主要功能包括会话的创建、启动、停止、状态查询、消息发送和文件上传等。API设计遵循RESTful原则，使用标准的HTTP方法和状态码。

V1 API引入了异步会话创建机制，通过`createConversation`方法创建会话启动任务，然后通过`getStartTask`方法轮询任务状态，直到会话准备就绪。这种设计提高了用户体验，避免了长时间的等待。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant V1API as V1 Conversation API
participant 后端服务 as 后端服务
前端->>V1API : createConversation()
V1API-->>前端 : 返回启动任务ID
前端->>V1API : getStartTask(taskId)
V1API-->>前端 : 返回任务状态 (WORKING)
前端->>V1API : getStartTask(taskId)
V1API-->>前端 : 返回任务状态 (READY)
前端->>V1API : resumeConversation()
V1API-->>后端服务 : 启动会话
后端服务-->>V1API : 会话已启动
V1API-->>前端 : 操作成功
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L56-L91)
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L196-L213)

## 核心操作

### 会话创建

会话创建是启动AI代理交互的第一步。V1 API使用异步创建模式，首先创建一个会话启动任务，然后轮询任务状态直到会话准备就绪。

```mermaid
flowchart TD
Start([开始创建会话]) --> CreateTask["调用createConversation创建启动任务"]
CreateTask --> CheckStatus["轮询getStartTask检查任务状态"]
CheckStatus --> IsReady{"状态是否为READY?"}
IsReady --> |否| CheckStatus
IsReady --> |是| GetConversationInfo["获取会话信息"]
GetConversationInfo --> Complete([会话创建完成])
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L56-L91)
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L100-L108)

### 会话启动与停止

会话启动和停止操作允许用户控制AI代理的执行状态。V1 API提供了`resumeConversation`和`pauseConversation`方法来控制会话的运行状态。

```mermaid
stateDiagram-v2
[*] --> 停止
停止 --> 运行 : resumeConversation()
运行 --> 暂停 : pauseConversation()
暂停 --> 运行 : resumeConversation()
运行 --> 停止 : stopConversation()
暂停 --> 停止 : stopConversation()
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L168-L185)
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L196-L213)

### 状态查询

会话状态查询API允许前端应用实时获取会话的当前状态。系统支持多种状态，包括启动中、运行中、已停止、已归档和错误等。

```mermaid
flowchart LR
A[获取会话状态] --> B{会话是否存在?}
B --> |是| C[返回会话信息]
B --> |否| D[返回404错误]
C --> E{会话是否正在运行?}
E --> |是| F[返回运行状态]
E --> |否| G[返回停止状态]
```

**Diagram sources**
- [manage_conversations.py](file://openhands/server/routes/manage_conversations.py#L433-L465)
- [conversation-status.ts](file://frontend/src/types/conversation-status.ts#L1-L6)

## 数据模型与类型约束

### V1会话数据模型

v1-conversation-service.types.ts文件定义了V1 API使用的数据模型和类型约束。这些类型确保了前后端之间的数据一致性。

```mermaid
classDiagram
class V1AppConversation {
+id : string
+created_by_user_id : string | null
+sandbox_id : string
+selected_repository : string | null
+selected_branch : string | null
+git_provider : Provider | null
+title : string | null
+trigger : ConversationTrigger | null
+pr_number : number[]
+llm_model : string | null
+metrics : unknown | null
+created_at : string
+updated_at : string
+sandbox_status : V1SandboxStatus
+execution_status : V1ConversationExecutionStatus | null
+conversation_url : string | null
+session_api_key : string | null
}
class V1AppConversationStartTask {
+id : string
+created_by_user_id : string | null
+status : V1AppConversationStartTaskStatus
+detail : string | null
+app_conversation_id : string | null
+sandbox_id : string | null
+agent_server_url : string | null
+request : V1AppConversationStartRequest
+created_at : string
+updated_at : string
}
class V1SendMessageRequest {
+role : V1Role
+content : V1MessageContent[]
}
V1AppConversation --> V1AppConversationStartTask : "包含"
V1AppConversationStartTask --> V1SendMessageRequest : "引用"
```

**Diagram sources**
- [v1-conversation-service.types.ts](file://frontend/src/api/conversation-service/v1-conversation-service.types.ts#L76-L94)
- [v1-conversation-service.types.ts](file://frontend/src/api/conversation-service/v1-conversation-service.types.ts#L45-L56)

### 类型约束详解

V1 API定义了严格的类型约束，确保数据的完整性和一致性。主要类型包括：

- **V1MessageContent**: 定义消息内容的结构，支持文本和图片URL
- **V1Role**: 定义消息角色，包括用户、系统、助手和工具
- **V1AppConversationStartTaskStatus**: 定义会话启动任务的状态
- **V1ConversationExecutionStatus**: 定义会话执行状态

这些类型约束在编译时就能捕获潜在的错误，提高了代码的可靠性和可维护性。

**Section sources**
- [v1-conversation-service.types.ts](file://frontend/src/api/conversation-service/v1-conversation-service.types.ts#L7-L94)

## 版本化API设计原则

### 版本兼容性

会话服务API采用版本化设计，确保向后兼容性。V1 API在路径中明确标识版本号（/api/v1/），避免与V0 API冲突。

```mermaid
graph TD
A[客户端请求] --> B{路径包含/v1/?}
B --> |是| C[路由到V1处理器]
B --> |否| D[路由到V0处理器]
C --> E[V1 API处理]
D --> F[V0 API处理]
E --> G[返回响应]
F --> G
```

**Diagram sources**
- [manage_conversations.py](file://openhands/server/routes/manage_conversations.py#L433-L465)
- [conversation.py](file://openhands/server/routes/conversation.py#L107-L139)

### 降级处理

系统实现了优雅的降级处理机制。当V1 API不可用时，系统会自动回退到V0 API，确保基本功能的可用性。

```mermaid
flowchart TD
A[调用V1 API] --> B{调用成功?}
B --> |是| C[返回结果]
B --> |否| D[调用V0 API]
D --> E{调用成功?}
E --> |是| F[返回结果]
E --> |否| G[返回错误]
```

**Diagram sources**
- [manage_conversations.py](file://openhands/server/routes/manage_conversations.py#L475-L485)
- [conversation.py](file://openhands/server/routes/conversation.py#L34-L57)

## 实际调用示例

### 会话创建示例

以下示例展示了如何使用V1 API创建会话：

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant API as V1 Conversation API
前端->>API : createConversation()
API-->>前端 : 返回启动任务
前端->>API : getStartTask(taskId)
API-->>前端 : 返回任务状态
前端->>API : getStartTask(taskId)
API-->>前端 : 返回任务状态 (READY)
前端->>API : resumeConversation()
API-->>前端 : 操作成功
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L56-L91)
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L196-L213)

### 文件上传示例

文件上传操作允许用户将会话所需的文件上传到工作区：

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant API as V1 Conversation API
前端->>API : uploadFile()
API-->>前端 : 等待上传
前端->>API : 发送文件数据
API-->>前端 : 上传成功
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L251-L277)

## 错误恢复机制

### 重试策略

系统实现了智能的重试策略，处理临时性错误。对于网络错误或服务暂时不可用的情况，客户端会自动重试请求。

```mermaid
flowchart TD
A[发送请求] --> B{响应成功?}
B --> |是| C[处理响应]
B --> |否| D{错误类型?}
D --> |网络错误| E[等待后重试]
D --> |认证错误| F[刷新令牌后重试]
D --> |其他错误| G[返回错误]
E --> A
F --> A
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L179-L184)
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L207-L212)

### 状态同步

会话状态同步机制确保前端UI与后端状态保持一致。系统定期轮询会话状态，并在状态变化时更新UI。

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 同步中 : 开始轮询
同步中 --> 已同步 : 状态匹配
同步中 --> 失败 : 轮询失败
失败 --> 重试 : 等待后重试
重试 --> 同步中
已同步 --> 同步中 : 状态变化
```

**Diagram sources**
- [use-user-conversation.ts](file://frontend/src/hooks/query/use-user-conversation.ts#L19-L38)
- [conversation-mutation-utils.ts](file://frontend/src/hooks/mutation/conversation-mutation-utils.ts#L106-L126)

## 最佳实践

### 性能优化

为了优化性能，建议采用以下最佳实践：

1. 使用批量操作减少网络请求
2. 合理设置轮询间隔，避免过度请求
3. 缓存常用数据，减少重复查询

```mermaid
flowchart TD
A[性能优化] --> B[批量操作]
A --> C[合理轮询]
A --> D[数据缓存]
B --> E[减少网络请求]
C --> F[降低服务器负载]
D --> G[提高响应速度]
```

**Diagram sources**
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L222-L239)
- [use-user-conversation.ts](file://frontend/src/hooks/query/use-user-conversation.ts#L35-L37)

### 安全考虑

安全是会话服务的重要方面。系统采用了多种安全措施：

1. 使用会话API密钥进行身份验证
2. 验证会话ID的格式，防止路径遍历攻击
3. 限制敏感操作的访问权限

```mermaid
flowchart TD
A[安全措施] --> B[API密钥验证]
A --> C[输入验证]
A --> D[权限控制]
B --> E[防止未授权访问]
C --> F[防止注入攻击]
D --> G[保护敏感数据]
```

**Diagram sources**
- [conversation.py](file://openhands/server/routes/conversation.py#L43-L55)
- [v1-conversation-service.api.ts](file://frontend/src/api/conversation-service/v1-conversation-service.api.ts#L177-L183)