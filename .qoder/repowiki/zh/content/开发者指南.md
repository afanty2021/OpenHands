# 开发者指南

<cite>
**本文档中引用的文件**   
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [Development.md](file://Development.md)
- [README.md](file://README.md)
- [pyproject.toml](file://pyproject.toml)
- [docker-compose.yml](file://docker-compose.yml)
- [Makefile](file://Makefile)
- [config.template.toml](file://config.template.toml)
- [enterprise/README.md](file://enterprise/README.md)
- [tests/unit/README.md](file://tests/unit/README.md)
- [dev_config/python/ruff.toml](file://dev_config/python/ruff.toml)
- [dev_config/python/mypy.ini](file://dev_config/python/mypy.ini)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [开发环境设置](#开发环境设置)
4. [代码风格与提交规范](#代码风格与提交规范)
5. [调试与性能分析](#调试与性能分析)
6. [测试方法](#测试方法)
7. [新功能开发流程](#新功能开发流程)
8. [版本发布与分支策略](#版本发布与分支策略)
9. [文档编写标准](#文档编写标准)
10. [常见问题解决方案](#常见问题解决方案)

## 简介
OpenHands是一个由AI驱动的软件开发代理平台，旨在帮助开发者更高效地编写代码。本指南为贡献者提供全面的开发指导，涵盖从环境设置到代码贡献的各个方面。

**Section sources**
- [README.md](file://README.md#L1-L185)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L124)

## 项目结构
OpenHands项目采用模块化设计，主要包含以下核心组件：

- **containers/**: Docker容器配置，包括开发、运行时和应用容器
- **openhands/**: 核心Python实现，包含代理、运行时、LLM等核心组件
- **frontend/**: 前端React应用，提供用户界面
- **enterprise/**: 企业版服务器代码，包含认证、用户设置等扩展功能
- **evaluation/**: 评估框架和基准测试
- **microagents/**: 微代理架构和实现
- **tests/**: 单元和集成测试

这种结构使得不同功能模块相互独立，便于维护和扩展。

**Section sources**
- [README.md](file://README.md#L1-L185)
- [project_structure](file://project_structure)

## 开发环境设置
### 系统要求
开发OpenHands需要以下依赖：

- Linux、Mac OS或Windows子系统(WSL) [Ubuntu >= 22.04]
- Docker
- Python = 3.12
- NodeJS >= 22.x
- Poetry >= 1.8

### 开发容器
项目提供了一个dev container，为支持的编辑器（如VS Code）提供预配置的开发环境。使用Dev Containers扩展，可以通过命令面板中的"Dev Container: Reopen in Container"命令在容器中打开项目。

### 构建与设置
使用Makefile进行项目构建和环境设置：

```bash
make build
```

此命令会检查依赖、安装Python和前端依赖、安装pre-commit钩子并构建前端。

### 配置语言模型
运行以下命令配置LLM：

```bash
make setup-config
```

此命令会提示输入LLM API密钥、模型名称和其他变量。

### 运行应用
有多种方式运行应用：

```bash
# 运行完整应用（后端和前端）
make run

# 单独启动后端
make start-backend

# 单独启动前端
make start-frontend
```

**Section sources**
- [Development.md](file://Development.md#L1-L205)
- [Makefile](file://Makefile#L1-L372)
- [docker-compose.yml](file://docker-compose.yml#L1-L24)

## 代码风格与提交规范
### 代码风格
项目使用以下工具确保代码质量：

- **ruff**: 代码格式化和linting
- **mypy**: 类型检查
- **pre-commit**: 提交前检查

配置文件位于`dev_config/python/`目录下，包含`ruff.toml`和`mypy.ini`。

### 提交规范
Pull Request标题应遵循以下前缀：

- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更改
- `style`: 代码格式更改
- `refactor`: 重构代码
- `perf`: 性能改进
- `test`: 添加或修正测试
- `build`: 构建系统更改
- `ci`: CI配置更改
- `chore`: 其他不修改源码或测试文件的更改
- `revert`: 撤销先前的提交

例如：`feat(frontend): 添加新功能`，其中`(frontend)`表示PR主要关注前端组件。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L63-L88)
- [dev_config/python/ruff.toml](file://dev_config/python/ruff.toml#L1-L43)
- [dev_config/python/mypy.ini](file://dev_config/python/mypy.ini#L1-L17)

## 调试与性能分析
### LLM调试
启用LLM调试模式：

```bash
export DEBUG=1
```

重启后端后，OpenHands会将提示和响应日志记录到`logs/llm/CURRENT_DATE`目录中，便于识别问题。

### 性能分析
项目包含性能分析工具，可用于评估代理性能。在`evaluation/benchmarks/`目录下有多个基准测试，包括：

- SWE-bench: 软件工程基准测试
- agent_bench: 代理性能基准测试
- testgeneval: 测试生成评估

这些工具可以帮助识别性能瓶颈并优化代码。

**Section sources**
- [Development.md](file://Development.md#L129-L133)
- [evaluation/benchmarks/swe_perf/run_infer.py](file://evaluation/benchmarks/swe_perf/run_infer.py#L176-L217)

## 测试方法
### 单元测试
单元测试位于`tests/unit/`目录下，使用pytest框架：

```bash
# 运行所有单元测试
poetry run pytest ./tests/unit

# 运行特定测试文件
poetry run pytest ./tests/unit/test_llm_fncall_converter.py

# 运行特定测试
poetry run pytest ./tests/unit/test_llm_fncall_converter.py::test_convert_tool_call_to_string
```

### 集成测试
集成测试位于`evaluation/integration_tests/`目录下，用于测试组件间的交互。

### 测试覆盖率
项目使用coverage.py工具确保代码覆盖率，配置在`pyproject.toml`中。

**Section sources**
- [tests/unit/README.md](file://tests/unit/README.md#L1-L30)
- [pyproject.toml](file://pyproject.toml#L140-L156)

## 新功能开发流程
### UI/UX改进
对于小的UI/UX修复，可以直接提交PR修改`frontend`目录。对于重大更改，建议先在Slack的#eng-ui-ux频道与设计团队讨论。

### 代理改进
主要代理是CodeAct代理，其提示位于`openhands/agenthub/codeact_agent`。修改提示或底层行为可能对用户体验产生重大影响，需要进行端到端评估。

### 添加新代理
可以在`openhands/agenthub`目录下添加新类型的代理，以扩展OpenHands的功能。

### 添加新运行时
代理需要一个运行代码和命令的地方。可以通过实现`openhands/runtime/base.py`中指定的接口来添加对新运行时的支持。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L26-L58)

## 版本发布与分支策略
### 版本发布
项目使用语义化版本控制，版本号格式为`MAJOR.MINOR.PATCH`。发布流程包括：

1. 在主分支上完成功能开发
2. 进行充分的测试和代码审查
3. 创建发布分支
4. 进行最终测试和文档更新
5. 发布新版本

### 分支策略
采用Git Flow工作流：

- `main`: 主分支，包含生产就绪代码
- `develop`: 开发分支，集成所有功能
- `feature/*`: 功能分支，开发新功能
- `release/*`: 发布分支，准备发布
- `hotfix/*`: 热修复分支，紧急修复

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L104-L123)
- [README.md](file://README.md#L153-L156)

## 文档编写标准
### 文档位置
关键文档包括：

- `/README.md`: 项目概述和基本设置
- `/Development.md`: 开发者指南
- `/CONTRIBUTING.md`: 贡献指南
- `/openhands/README.md`: 后端Python实现详情
- `/frontend/README.md`: 前端React应用指南

### 文档风格
遵循Google文档风格指南，使用清晰、简洁的语言。代码示例应完整且可运行。

### 文档更新
每次功能更新或API更改时，都应相应更新文档。文档与代码应保持同步。

**Section sources**
- [Development.md](file://Development.md#L189-L205)
- [README.md](file://README.md#L135-L142)

## 常见问题解决方案
### 依赖问题
如果遇到依赖问题，确保所有系统依赖已正确安装。可以使用conda或mamba管理包：

```bash
# 使用mamba安装依赖
mamba install python=3.12
mamba install conda-forge::nodejs
mamba install conda-forge::poetry
```

### Docker问题
确保Docker已正确安装并运行。在MacOS上，确保允许使用默认Docker套接字。

### 认证问题
企业版使用OAuth进行认证，而开源版使用个人访问令牌(PAT)。确保使用正确的认证方法。

### 性能问题
如果遇到性能问题，可以启用调试模式分析瓶颈，或使用内置的性能分析工具。

**Section sources**
- [Development.md](file://Development.md#L1-L205)
- [enterprise/README.md](file://enterprise/README.md#L1-L57)