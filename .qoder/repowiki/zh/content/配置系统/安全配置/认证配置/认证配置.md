# è®¤è¯é…ç½®

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [keycloak_manager.py](file://enterprise/server/auth/keycloak_manager.py)
- [token_manager.py](file://enterprise/server/auth/token_manager.py)
- [auth.py](file://enterprise/server/routes/auth.py)
- [gitlab_sync.py](file://enterprise/server/auth/gitlab_sync.py)
- [github_utils.py](file://enterprise/server/auth/github_utils.py)
- [constants.py](file://enterprise/server/auth/constants.py)
- [middleware.py](file://enterprise/server/middleware.py)
- [saas_user_auth.py](file://enterprise/server/auth/saas_user_auth.py)
- [auth_error.py](file://enterprise/server/auth/auth_error.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [è®¤è¯æ¶æ„æ¦‚è§ˆ](#è®¤è¯æ¶æ„æ¦‚è§ˆ)
3. [Keycloaké›†æˆé…ç½®](#keycloaké›†æˆé…ç½®)
4. [OAuth2è®¤è¯æµç¨‹](#oauth2è®¤è¯æµç¨‹)
5. [GitHub OAuth2é…ç½®](#github-oauth2é…ç½®)
6. [GitLabåŒæ­¥è®¤è¯](#gitlabåŒæ­¥è®¤è¯)
7. [JWTä»¤ç‰Œç®¡ç†](#jwtä»¤ç‰Œç®¡ç†)
8. [ä¼šè¯ç®¡ç†ä¸è¶…æ—¶è®¾ç½®](#ä¼šè¯ç®¡ç†ä¸è¶…æ—¶è®¾ç½®)
9. [å¤šå› ç´ è®¤è¯æ”¯æŒ](#å¤šå› ç´ è®¤è¯æ”¯æŒ)
10. [è®¤è¯ä¸­é—´ä»¶](#è®¤è¯ä¸­é—´ä»¶)
11. [é”™è¯¯å¤„ç†ä¸æ•…éšœæ’é™¤](#é”™è¯¯å¤„ç†ä¸æ•…éšœæ’é™¤)
12. [éƒ¨ç½²ç¯å¢ƒé…ç½®](#éƒ¨ç½²ç¯å¢ƒé…ç½®)
13. [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)

## ç®€ä»‹

OpenHandsæä¾›äº†å…¨é¢çš„è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§èº«ä»½æä¾›å•†ï¼ˆIdPï¼‰å’Œè®¤è¯æœºåˆ¶ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„OAuth2åè®®ï¼Œç»“åˆJWTä»¤ç‰Œç®¡ç†å’ŒKeycloaké›†æˆï¼Œä¸ºç”¨æˆ·æä¾›å®‰å…¨å¯é çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰ä½“éªŒã€‚

### æ”¯æŒçš„è®¤è¯æ–¹å¼

- **Keycloaké›†æˆ**ï¼šä¼ä¸šçº§èº«ä»½è®¤è¯è§£å†³æ–¹æ¡ˆ
- **GitHub OAuth2**ï¼šå¼€æºå¼€å‘è€…é¦–é€‰è®¤è¯æ–¹å¼
- **GitLabé›†æˆ**ï¼šä¼ä¸šçº§ä»£ç æ‰˜ç®¡å¹³å°è®¤è¯
- **Bitbucketé›†æˆ**ï¼šAtlassianä»£ç æ‰˜ç®¡å¹³å°è®¤è¯
- **è‡ªå®šä¹‰SSO**ï¼šæ”¯æŒä¼ä¸šå†…éƒ¨å•ç‚¹ç™»å½•

## è®¤è¯æ¶æ„æ¦‚è§ˆ

OpenHandsçš„è®¤è¯ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œç¡®ä¿å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚

```mermaid
graph TB
subgraph "å‰ç«¯å±‚"
UI[ç”¨æˆ·ç•Œé¢]
AuthModal[è®¤è¯æ¨¡æ€æ¡†]
end
subgraph "APIç½‘å…³å±‚"
Middleware[è®¤è¯ä¸­é—´ä»¶]
Routes[è·¯ç”±å¤„ç†å™¨]
end
subgraph "è®¤è¯æœåŠ¡å±‚"
TokenManager[ä»¤ç‰Œç®¡ç†å™¨]
KeycloakManager[Keycloakç®¡ç†å™¨]
UserVerifier[ç”¨æˆ·éªŒè¯å™¨]
end
subgraph "èº«ä»½æä¾›å•†"
Keycloak[KeycloakæœåŠ¡å™¨]
GitHub[GitHub OAuth2]
GitLab[GitLab OAuth2]
Bitbucket[Bitbucket OAuth2]
end
subgraph "å­˜å‚¨å±‚"
AuthTokenStore[è®¤è¯ä»¤ç‰Œå­˜å‚¨]
OfflineTokenStore[ç¦»çº¿ä»¤ç‰Œå­˜å‚¨]
UserSettings[ç”¨æˆ·è®¾ç½®]
end
UI --> AuthModal
AuthModal --> Routes
Routes --> Middleware
Middleware --> TokenManager
TokenManager --> KeycloakManager
KeycloakManager --> Keycloak
TokenManager --> GitHub
TokenManager --> GitLab
TokenManager --> Bitbucket
TokenManager --> AuthTokenStore
TokenManager --> OfflineTokenStore
TokenManager --> UserSettings
UserVerifier --> UserSettings
```

**å›¾è¡¨æ¥æº**
- [middleware.py](file://enterprise/server/middleware.py#L26-L175)
- [token_manager.py](file://enterprise/server/auth/token_manager.py#L78-L672)
- [keycloak_manager.py](file://enterprise/server/auth/keycloak_manager.py#L21-L51)

## Keycloaké›†æˆé…ç½®

Keycloakæ˜¯OpenHandsçš„ä¸»è¦èº«ä»½æä¾›å•†ï¼Œæä¾›ä¼ä¸šçº§è®¤è¯æœåŠ¡ã€‚

### åŸºç¡€é…ç½®å‚æ•°

| é…ç½®é¡¹ | æè¿° | ç¤ºä¾‹å€¼ | å¿…éœ€ |
|--------|------|--------|------|
| `KEYCLOAK_SERVER_URL` | KeycloakæœåŠ¡å™¨åœ°å€ | `https://auth.example.com` | æ˜¯ |
| `KEYCLOAK_REALM_NAME` | è®¤è¯åŸŸåç§° | `openhands` | æ˜¯ |
| `KEYCLOAK_CLIENT_ID` | å®¢æˆ·ç«¯ID | `openhands-client` | æ˜¯ |
| `KEYCLOAK_CLIENT_SECRET` | å®¢æˆ·ç«¯å¯†é’¥ | `your-client-secret` | æ˜¯ |
| `KEYCLOAK_SERVER_URL_EXT` | å¤–éƒ¨è®¿é—®URL | `https://auth.example.com` | å¦ |

### Keycloakå®¢æˆ·ç«¯é…ç½®

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯åº”ç”¨
participant Keycloak as KeycloakæœåŠ¡å™¨
participant Backend as OpenHandsåç«¯
Client->>Keycloak : å‘èµ·OAuth2æˆæƒè¯·æ±‚
Keycloak->>Client : é‡å®šå‘åˆ°ç™»å½•é¡µé¢
Client->>Keycloak : ç”¨æˆ·è¾“å…¥å‡­æ®
Keycloak->>Client : è¿”å›æˆæƒç 
Client->>Backend : å‘é€æˆæƒç 
Backend->>Keycloak : äº¤æ¢è®¿é—®ä»¤ç‰Œ
Keycloak->>Backend : è¿”å›è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œ
Backend->>Backend : å­˜å‚¨ä»¤ç‰Œå¹¶åˆ›å»ºJWT
Backend->>Client : è®¾ç½®è®¤è¯Cookie
```

**å›¾è¡¨æ¥æº**
- [auth.py](file://enterprise/server/routes/auth.py#L99-L248)
- [token_manager.py](file://enterprise/server/auth/token_manager.py#L89-L111)

### ç¦»çº¿è®¿é—®ä»¤ç‰Œé…ç½®

ç¦»çº¿è®¿é—®ä»¤ç‰Œå…è®¸åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·ä¸æ´»è·ƒæ—¶ä¿æŒè®¤è¯çŠ¶æ€ï¼š

```python
# ç¦»çº¿ä»¤ç‰Œåˆ·æ–°æµç¨‹
async def keycloak_offline_callback(code: str, state: str, request: Request):
    # è·å–Keycloakä»¤ç‰Œ
    keycloak_access_token, keycloak_refresh_token = await token_manager.get_keycloak_tokens(code, redirect_uri)
    
    # å­˜å‚¨ç¦»çº¿ä»¤ç‰Œ
    await token_manager.store_offline_token(user_id=user_info['sub'], offline_token=keycloak_refresh_token)
    
    return RedirectResponse(state if state else request.base_url, status_code=302)
```

**ç« èŠ‚æ¥æº**
- [auth.py](file://enterprise/server/routes/auth.py#L251-L286)
- [token_manager.py](file://enterprise/server/auth/token_manager.py#L585-L590)

## OAuth2è®¤è¯æµç¨‹

OpenHandså®ç°äº†å®Œæ•´çš„OAuth2è®¤è¯æµç¨‹ï¼Œæ”¯æŒæ ‡å‡†çš„æˆæƒç æ¨¡å¼ã€‚

### è®¤è¯æµç¨‹å›¾

```mermaid
flowchart TD
Start([ç”¨æˆ·è®¿é—®åº”ç”¨]) --> CheckAuth{æ£€æŸ¥ç°æœ‰è®¤è¯}
CheckAuth --> |å·²è®¤è¯| AllowAccess[å…è®¸è®¿é—®]
CheckAuth --> |æœªè®¤è¯| RedirectAuth[é‡å®šå‘åˆ°èº«ä»½æä¾›å•†]
RedirectAuth --> AuthProvider[èº«ä»½æä¾›å•†è®¤è¯]
AuthProvider --> AuthSuccess{è®¤è¯æˆåŠŸ?}
AuthSuccess --> |æ˜¯| ExchangeCode[äº¤æ¢æˆæƒç ]
AuthSuccess --> |å¦| AuthError[è®¤è¯å¤±è´¥]
ExchangeCode --> StoreTokens[å­˜å‚¨ä»¤ç‰Œ]
StoreTokens --> CreateJWT[åˆ›å»ºJWTä»¤ç‰Œ]
CreateJWT --> SetCookie[è®¾ç½®è®¤è¯Cookie]
SetCookie --> SyncRepos[åŒæ­¥ä»“åº“ä¿¡æ¯]
SyncRepos --> AllowAccess
AuthError --> ErrorHandler[é”™è¯¯å¤„ç†]
ErrorHandler --> RedirectAuth
```

**å›¾è¡¨æ¥æº**
- [auth.py](file://enterprise/server/routes/auth.py#L99-L248)
- [middleware.py](file://enterprise/server/middleware.py#L32-L97)

### GitHub OAuth2é…ç½®

GitHub OAuth2é›†æˆæ”¯æŒä¸ªäººå¼€å‘è€…å’Œä¼ä¸šç”¨æˆ·ï¼š

| é…ç½®é¡¹ | æè¿° | ç¤ºä¾‹å€¼ | å¿…éœ€ |
|--------|------|--------|------|
| `GITHUB_APP_CLIENT_ID` | GitHubåº”ç”¨å®¢æˆ·ç«¯ID | `Iv1.xxxx` | æ˜¯ |
| `GITHUB_APP_CLIENT_SECRET` | GitHubåº”ç”¨å®¢æˆ·ç«¯å¯†é’¥ | `your-client-secret` | æ˜¯ |
| `GITHUB_APP_PRIVATE_KEY` | GitHubåº”ç”¨ç§é’¥ | `-----BEGIN RSA PRIVATE KEY-----\n...` | æ˜¯ |
| `GITHUB_APP_WEBHOOK_SECRET` | Webhookç­¾åå¯†é’¥ | `your-webhook-secret` | å¦ |

### GitLab OAuth2é…ç½®

GitLabé›†æˆæä¾›ä¼ä¸šçº§ä»£ç ç®¡ç†åŠŸèƒ½ï¼š

| é…ç½®é¡¹ | æè¿° | ç¤ºä¾‹å€¼ | å¿…éœ€ |
|--------|------|--------|------|
| `GITLAB_APP_CLIENT_ID` | GitLabåº”ç”¨å®¢æˆ·ç«¯ID | `xxxxxx` | æ˜¯ |
| `GITLAB_APP_CLIENT_SECRET` | GitLabåº”ç”¨å®¢æˆ·ç«¯å¯†é’¥ | `xxxxxx` | æ˜¯ |

**ç« èŠ‚æ¥æº**
- [constants.py](file://enterprise/server/auth/constants.py#L3-L17)
- [github_utils.py](file://enterprise/server/auth/github_utils.py#L11-L127)

## GitLabåŒæ­¥è®¤è¯

GitLabåŒæ­¥åŠŸèƒ½ç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿæ— ç¼è®¿é—®å…¶GitLabä»“åº“ã€‚

### åŒæ­¥æµç¨‹

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Frontend as å‰ç«¯
participant Backend as åç«¯
participant GitLab as GitLab API
User->>Frontend : ç™»å½•åº”ç”¨
Frontend->>Backend : è®¤è¯å›è°ƒ
Backend->>Backend : éªŒè¯ç”¨æˆ·èº«ä»½
Backend->>GitLab : è·å–ç”¨æˆ·ä»“åº“åˆ—è¡¨
GitLab->>Backend : è¿”å›ä»“åº“æ•°æ®
Backend->>Backend : å­˜å‚¨ä»“åº“ä¿¡æ¯
Backend->>Frontend : åŒæ­¥å®Œæˆå“åº”
User->>Frontend : å¯ä»¥è®¿é—®GitLabä»“åº“
```

**å›¾è¡¨æ¥æº**
- [gitlab_sync.py](file://enterprise/server/auth/gitlab_sync.py#L10-L32)
- [auth.py](file://enterprise/server/routes/auth.py#L244-L248)

### èƒŒæ™¯ä»»åŠ¡è°ƒåº¦

GitLabä»“åº“åŒæ­¥ä½œä¸ºåå°ä»»åŠ¡æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»æµç¨‹ï¼š

```python
def schedule_gitlab_repo_sync(user_id: str, keycloak_access_token: SecretStr | None = None) -> None:
    """è°ƒåº¦GitLabä»“åº“åŒæ­¥å’ŒWebhookè·Ÿè¸ªçš„åå°ä»»åŠ¡"""
    
    async def _run():
        try:
            service = SaaSGitLabService(
                external_auth_id=user_id, 
                external_auth_token=keycloak_access_token
            )
            await service.get_all_repositories(
                'pushed', AppMode.SAAS, store_in_background=False
            )
        except Exception:
            logger.warning('gitlab_repo_sync_failed', exc_info=True)
    
    asyncio.create_task(_run())
```

**ç« èŠ‚æ¥æº**
- [gitlab_sync.py](file://enterprise/server/auth/gitlab_sync.py#L10-L32)

## JWTä»¤ç‰Œç®¡ç†

OpenHandsä½¿ç”¨JWTï¼ˆJSON Web Tokenï¼‰è¿›è¡Œæ— çŠ¶æ€è®¤è¯ï¼Œæ”¯æŒä»¤ç‰Œåˆ·æ–°å’Œè‡ªåŠ¨ç»­æœŸã€‚

### ä»¤ç‰Œç»“æ„

```mermaid
graph LR
subgraph "JWTä»¤ç‰Œç»“æ„"
Header[Header<br/>ç®—æ³•å’Œç±»å‹]
Payload[Payload<br/>ç”¨æˆ·ä¿¡æ¯å’Œå£°æ˜]
Signature[Signature<br/>ç­¾åéªŒè¯]
end
Header --> Payload
Payload --> Signature
```

### ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸç®¡ç†

| é˜¶æ®µ | æ—¶é—´ç‚¹ | æ“ä½œ | æè¿° |
|------|--------|------|------|
| åˆ›å»º | ç”¨æˆ·è®¤è¯æ—¶ | ç”ŸæˆJWT | åŒ…å«ç”¨æˆ·IDã€æƒé™å’Œè¿‡æœŸæ—¶é—´ |
| ä½¿ç”¨ | APIè¯·æ±‚æ—¶ | éªŒè¯JWT | æ£€æŸ¥ç­¾åå’Œè¿‡æœŸæ—¶é—´ |
| åˆ·æ–° | æ¥è¿‘è¿‡æœŸæ—¶ | è‡ªåŠ¨åˆ·æ–° | ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°JWT |
| åºŸå¼ƒ | ä¸»åŠ¨ç™»å‡º | æ¸…é™¤Cookie | åˆ é™¤å®¢æˆ·ç«¯è®¤è¯ä¿¡æ¯ |

### ä»¤ç‰Œåˆ·æ–°ç­–ç•¥

```mermaid
flowchart TD
CheckToken{æ£€æŸ¥ä»¤ç‰ŒçŠ¶æ€} --> TokenValid{ä»¤ç‰Œæœ‰æ•ˆ?}
TokenValid --> |æ˜¯| UseToken[ä½¿ç”¨ç°æœ‰ä»¤ç‰Œ]
TokenValid --> |å¦| CheckRefresh{åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆ?}
CheckRefresh --> |æ˜¯| RefreshToken[åˆ·æ–°ä»¤ç‰Œ]
CheckRefresh --> |å¦| RequireLogin[è¦æ±‚é‡æ–°ç™»å½•]
RefreshToken --> UpdateToken[æ›´æ–°ä»¤ç‰Œ]
UpdateToken --> UseToken
RequireLogin --> LoginFlow[ç™»å½•æµç¨‹]
```

**å›¾è¡¨æ¥æº**
- [token_manager.py](file://enterprise/server/auth/token_manager.py#L289-L322)
- [saas_user_auth.py](file://enterprise/server/auth/saas_user_auth.py#L69-L78)

### ä»¤ç‰ŒåŠ å¯†é…ç½®

ç³»ç»Ÿä½¿ç”¨å¯¹ç§°åŠ å¯†ä¿æŠ¤æ•æ„Ÿä»¤ç‰Œä¿¡æ¯ï¼š

```python
def create_encryption_utility(secret_key: bytes):
    """åˆ›å»ºåŠ å¯†å·¥å…·ï¼Œä½¿ç”¨32å­—èŠ‚å¯†é’¥"""
    # å°†32å­—èŠ‚å¯†é’¥è½¬æ¢ä¸ºFernetå¯†é’¥ï¼ˆ32å­—èŠ‚URLå®‰å…¨Base64ï¼‰
    fernet_key = b64encode(hashlib.sha256(secret_key).digest())
    f = Fernet(fernet_key)
    
    def encrypt_text(text: str) -> str:
        return f.encrypt(text.encode()).decode()
    
    def decrypt_text(encrypted_text: str) -> str:
        return f.decrypt(encrypted_text.encode()).decode()
    
    return encrypt_payload, decrypt_payload, encrypt_text, decrypt_text
```

**ç« èŠ‚æ¥æº**
- [token_manager.py](file://enterprise/server/auth/token_manager.py#L47-L75)

## ä¼šè¯ç®¡ç†ä¸è¶…æ—¶è®¾ç½®

OpenHandsæä¾›äº†çµæ´»çš„ä¼šè¯ç®¡ç†æœºåˆ¶ï¼Œæ”¯æŒå¤šç§è¶…æ—¶ç­–ç•¥ã€‚

### ä¼šè¯è¶…æ—¶é…ç½®

| å‚æ•° | é»˜è®¤å€¼ | æè¿° | é…ç½®æ–¹å¼ |
|------|--------|------|----------|
| è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸ | 1å°æ—¶ | JWTè®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ | ç³»ç»Ÿè‡ªåŠ¨è®¾ç½® |
| åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ | 30å¤© | JWTåˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ | Keycloaké…ç½® |
| ä¼šè¯è¶…æ—¶ | 8å°æ—¶ | ç”¨æˆ·ä¸æ´»åŠ¨åçš„ä¼šè¯è¶…æ—¶ | Cookieé…ç½® |
| è‡ªåŠ¨åˆ·æ–°é˜ˆå€¼ | 4å°æ—¶ | æå‰åˆ·æ–°çš„å‰©ä½™æ—¶é—´ | ç³»ç»Ÿé»˜è®¤ |

### Cookieå®‰å…¨é…ç½®

```mermaid
graph TB
subgraph "Cookieå®‰å…¨è®¾ç½®"
Secure[Secureæ ‡å¿—]
HttpOnly[HttpOnlyæ ‡å¿—]
SameSite[SameSiteç­–ç•¥]
Domain[åŸŸåé™åˆ¶]
end
Secure --> HttpOnly
HttpOnly --> SameSite
SameSite --> Domain
Secure -.->|HTTPSç¯å¢ƒ| True1[å¯ç”¨]
Secure -.->|HTTPç¯å¢ƒ| False1[ç¦ç”¨]
HttpOnly -.->|é˜²æ­¢XSS| True2[å¯ç”¨]
SameSite -.->|ä¸¥æ ¼æ¨¡å¼| Strict[Strict]
SameSite -.->|å®½æ¾æ¨¡å¼| Lax[Lax]
Domain -.->|å­åŸŸåéš”ç¦»| SubDomain[å­åŸŸåé™åˆ¶]
```

**å›¾è¡¨æ¥æº**
- [middleware.py](file://enterprise/server/middleware.py#L80-L96)
- [auth.py](file://enterprise/server/routes/auth.py#L43-L77)

### ä¼šè¯æ¸…ç†æœºåˆ¶

ç³»ç»Ÿå®ç°äº†è‡ªåŠ¨ä¼šè¯æ¸…ç†åŠŸèƒ½ï¼š

```python
async def logout(self, refresh_token: str):
    """ç”¨æˆ·ç™»å‡ºå¤„ç†"""
    try:
        # å‘Keycloakå‘é€ç™»å‡ºè¯·æ±‚
        await get_keycloak_openid(self.external).a_logout(refresh_token=refresh_token)
    except Exception:
        logger.exception('ç™»å‡ºKeycloakæ—¶å‘ç”Ÿå¼‚å¸¸')
        raise
```

**ç« èŠ‚æ¥æº**
- [token_manager.py](file://enterprise/server/auth/token_manager.py#L664-L672)
- [auth.py](file://enterprise/server/routes/auth.py#L380-L406)

## å¤šå› ç´ è®¤è¯æ”¯æŒ

OpenHandsæ”¯æŒå¤šç§å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰æ–¹æ¡ˆï¼Œå¢å¼ºè´¦æˆ·å®‰å…¨æ€§ã€‚

### MFAè®¤è¯æµç¨‹

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant App as åº”ç”¨ç¨‹åº
participant IdP as èº«ä»½æä¾›å•†
participant MFA as MFAè®¾å¤‡
User->>App : è¾“å…¥ç”¨æˆ·åå¯†ç 
App->>IdP : å‘é€è®¤è¯è¯·æ±‚
IdP->>User : è¯·æ±‚MFAéªŒè¯
User->>MFA : è¾“å…¥éªŒè¯ç /æŒ‡çº¹
MFA->>IdP : è¿”å›éªŒè¯ç»“æœ
IdP->>App : è¿”å›æœ€ç»ˆè®¤è¯ç»“æœ
App->>User : ç™»å½•æˆåŠŸ
```

### æ”¯æŒçš„MFAæ–¹å¼

| æ–¹å¼ | æè¿° | å®ç°çŠ¶æ€ | é…ç½®è¦æ±‚ |
|------|------|----------|----------|
| çŸ­ä¿¡éªŒè¯ç  | é€šè¿‡æ‰‹æœºçŸ­ä¿¡å‘é€ä¸€æ¬¡æ€§éªŒè¯ç  | âœ… å·²æ”¯æŒ | SMSæœåŠ¡é›†æˆ |
| é‚®ç®±éªŒè¯ | é€šè¿‡é‚®ç®±å‘é€éªŒè¯é“¾æ¥ | âœ… å·²æ”¯æŒ | SMTPé…ç½® |
| æ—¶é—´åŸºç¡€OTP | åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ï¼ˆTOTPï¼‰ | âœ… å·²æ”¯æŒ | TOTPåº”ç”¨ |
| ç¡¬ä»¶ä»¤ç‰Œ | ç‰©ç†å®‰å…¨ä»¤ç‰Œ | âš ï¸ éœ€è¦é›†æˆ | ç¡¬ä»¶ä¾›åº”å•†API |
| ç”Ÿç‰©è¯†åˆ« | æŒ‡çº¹/é¢éƒ¨è¯†åˆ« | ğŸ”„ å¼€å‘ä¸­ | è®¾å¤‡å…¼å®¹æ€§ |

## è®¤è¯ä¸­é—´ä»¶

è®¤è¯ä¸­é—´ä»¶è´Ÿè´£æ‹¦æˆªæ‰€æœ‰APIè¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èº«ä»½å¹¶å¤„ç†è®¤è¯é€»è¾‘ã€‚

### ä¸­é—´ä»¶å·¥ä½œæµç¨‹

```mermaid
flowchart TD
Request[æ¥æ”¶è¯·æ±‚] --> CheckMethod{æ£€æŸ¥HTTPæ–¹æ³•}
CheckMethod --> |OPTIONS| Skip[è·³è¿‡è®¤è¯]
CheckMethod --> |å…¶ä»–| CheckPath{æ£€æŸ¥è¯·æ±‚è·¯å¾„}
CheckPath --> |ç‰¹æ®Šè·¯å¾„| Skip
CheckPath --> |æ™®é€šAPI| ExtractToken[æå–è®¤è¯ä»¤ç‰Œ]
ExtractToken --> ValidateToken{éªŒè¯ä»¤ç‰Œ}
ValidateToken --> |æœ‰æ•ˆ| AttachUser[é™„åŠ ç”¨æˆ·ä¿¡æ¯]
ValidateToken --> |æ— æ•ˆ| HandleError[å¤„ç†è®¤è¯é”™è¯¯]
AttachUser --> NextMiddleware[ä¸‹ä¸€ä¸ªä¸­é—´ä»¶]
HandleError --> CleanupCookie[æ¸…ç†Cookie]
CleanupCookie --> ErrorResponse[è¿”å›é”™è¯¯å“åº”]
Skip --> NextMiddleware
NextMiddleware --> Response[è¿”å›å“åº”]
```

**å›¾è¡¨æ¥æº**
- [middleware.py](file://enterprise/server/middleware.py#L32-L97)

### é”™è¯¯å¤„ç†æœºåˆ¶

ä¸­é—´ä»¶å®ç°äº†å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
class SetAuthCookieMiddleware:
    async def __call__(self, request: Request, call_next: Callable):
        try:
            response: Response = await call_next(request)
            
            # å¦‚æœéœ€è¦åˆ·æ–°è®¤è¯Cookie
            if user_auth.refreshed:
                set_response_cookie(...)
                
            return response
            
        except AuthError as e:
            # è®°å½•è®¤è¯é”™è¯¯æ—¥å¿—
            logger.warning('auth_error', exc_info=True)
            
            # æ‰§è¡Œè‡ªåŠ¨ç™»å‡º
            await self._logout(request)
            
            # åˆ é™¤è®¤è¯Cookie
            response.delete_cookie(...)
            
            return JSONResponse(...)
```

**ç« èŠ‚æ¥æº**
- [middleware.py](file://enterprise/server/middleware.py#L69-L97)

## é”™è¯¯å¤„ç†ä¸æ•…éšœæ’é™¤

OpenHandsæä¾›äº†è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†æœºåˆ¶ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

### è®¤è¯é”™è¯¯ç±»å‹

| é”™è¯¯ç±»å‹ | å¼‚å¸¸ç±» | æè¿° | è§£å†³æ–¹æ¡ˆ |
|----------|--------|------|----------|
| NoCredentialsError | æ— å‡­æ®é”™è¯¯ | ç”¨æˆ·æœªæä¾›è®¤è¯ä¿¡æ¯ | æ£€æŸ¥Cookieæˆ–Bearer Token |
| AuthError | é€šç”¨è®¤è¯é”™è¯¯ | ä¸€èˆ¬è®¤è¯å¤±è´¥ | é‡æ–°ç™»å½•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ |
| EmailNotVerifiedError | é‚®ç®±æœªéªŒè¯ | ç”¨æˆ·é‚®ç®±æœªéªŒè¯ | å®Œæˆé‚®ç®±éªŒè¯æµç¨‹ |
| BearerTokenError | Bearerä»¤ç‰Œé”™è¯¯ | ä»¤ç‰Œæ ¼å¼æˆ–ç­¾åé”™è¯¯ | æ£€æŸ¥ä»¤ç‰Œæ ¼å¼ |
| CookieError | Cookieé”™è¯¯ | Cookieè§£ç å¤±è´¥ | æ¸…é™¤æµè§ˆå™¨Cookie |
| TosNotAcceptedError | æ¡æ¬¾æœªæ¥å— | ç”¨æˆ·æœªæ¥å—æœåŠ¡æ¡æ¬¾ | è·³è½¬åˆ°æ¡æ¬¾æ¥å—é¡µé¢ |
| ExpiredError | ä»¤ç‰Œè¿‡æœŸ | åˆ·æ–°ä»¤ç‰Œå·²è¿‡æœŸ | é‡æ–°ç™»å½• |

### å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. ä»¤ç‰Œå¤±æ•ˆé—®é¢˜

**ç—‡çŠ¶**ï¼šç”¨æˆ·æ”¶åˆ°401æœªæˆæƒé”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# æ£€æŸ¥JWTä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
jwt.io

# éªŒè¯åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæ€§
curl -X POST \
  "https://auth.example.com/realms/openhands/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "client_id=openhands-client" \
  -d "client_secret=your-secret" \
  -d "grant_type=refresh_token" \
  -d "refresh_token=your-refresh-token"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç³»ç»Ÿæ—¶é—´åŒæ­¥
- éªŒè¯å¯†é’¥é…ç½®æ­£ç¡®æ€§
- ç¡®è®¤KeycloakæœåŠ¡å™¨å¯ç”¨æ€§

#### 2. ç¬¬ä¸‰æ–¹æœåŠ¡è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šGitHub/GitLabé›†æˆæ— æ³•æ­£å¸¸å·¥ä½œ

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# æµ‹è¯•GitHub APIè¿æ¥
curl -H "Authorization: token YOUR_GITHUB_TOKEN" \
  https://api.github.com/user

# æµ‹è¯•GitLab APIè¿æ¥  
curl -H "PRIVATE-TOKEN: YOUR_GITLAB_TOKEN" \
  https://gitlab.com/api/v4/user
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥åº”ç”¨æ³¨å†Œé…ç½®
- éªŒè¯å›è°ƒURLè®¾ç½®
- ç¡®è®¤é˜²ç«å¢™è§„åˆ™å…è®¸å¤–éƒ¨è¿æ¥

#### 3. ä¼šè¯ç®¡ç†é—®é¢˜

**ç—‡çŠ¶**ï¼šç”¨æˆ·é¢‘ç¹éœ€è¦é‡æ–°ç™»å½•

**æ’æŸ¥æ­¥éª¤**ï¼š
- æ£€æŸ¥Cookieé…ç½®
- éªŒè¯JWTå¯†é’¥ä¸€è‡´æ€§
- ç¡®è®¤ä¼šè¯è¶…æ—¶è®¾ç½®

**ç« èŠ‚æ¥æº**
- [auth_error.py](file://enterprise/server/auth/auth_error.py#L1-L41)
- [middleware.py](file://enterprise/server/middleware.py#L69-L97)

## éƒ¨ç½²ç¯å¢ƒé…ç½®

OpenHandsæ”¯æŒå¤šç§éƒ¨ç½²ç¯å¢ƒï¼Œæ¯ç§ç¯å¢ƒéƒ½æœ‰ç‰¹å®šçš„é…ç½®è¦æ±‚ã€‚

### å¼€å‘ç¯å¢ƒé…ç½®

å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°Keycloakå®ä¾‹ï¼š

```yaml
# docker-compose.yml ç¤ºä¾‹
version: '3.8'
services:
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    command: start-dev
    ports:
      - "8080:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      
  openhands:
    build: .
    ports:
      - "8090:8090"
    environment:
      - KEYCLOAK_SERVER_URL=http://localhost:8080
      - KEYCLOAK_REALM_NAME=openhands
      - KEYCLOAK_CLIENT_ID=openhands-client
      - KEYCLOAK_CLIENT_SECRET=your-secret
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´ä¸¥æ ¼çš„å®‰å…¨é…ç½®ï¼š

```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹
environment:
  # Keycloaké…ç½®
  - KEYCLOAK_SERVER_URL=https://auth.company.com
  - KEYCLOAK_REALM_NAME=production
  - KEYCLOAK_CLIENT_ID=openhands-prod
  - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
  
  # GitHubé›†æˆ
  - GITHUB_APP_CLIENT_ID=${GITHUB_APP_CLIENT_ID}
  - GITHUB_APP_CLIENT_SECRET=${GITHUB_APP_CLIENT_SECRET}
  - GITHUB_APP_PRIVATE_KEY=${GITHUB_APP_PRIVATE_KEY}
  
  # å®‰å…¨é…ç½®
  - JWT_SECRET=${JWT_SECRET}
  - SESSION_COOKIE_SECURE=true
  
  # æ•°æ®åº“é…ç½®
  - DATABASE_URL=${DATABASE_URL}
```

### ç¯å¢ƒå˜é‡é…ç½®è¡¨

| ç¯å¢ƒå˜é‡ | æè¿° | é»˜è®¤å€¼ | å®‰å…¨çº§åˆ« |
|----------|------|--------|----------|
| `KEYCLOAK_SERVER_URL` | KeycloakæœåŠ¡å™¨åœ°å€ | - | é«˜ |
| `KEYCLOAK_REALM_NAME` | è®¤è¯åŸŸåç§° | - | ä¸­ |
| `KEYCLOAK_CLIENT_ID` | å®¢æˆ·ç«¯ID | - | é«˜ |
| `KEYCLOAK_CLIENT_SECRET` | å®¢æˆ·ç«¯å¯†é’¥ | - | æé«˜ |
| `GITHUB_APP_CLIENT_ID` | GitHubåº”ç”¨ID | - | é«˜ |
| `GITHUB_APP_CLIENT_SECRET` | GitHubåº”ç”¨å¯†é’¥ | - | æé«˜ |
| `JWT_SECRET` | JWTç­¾åå¯†é’¥ | - | æé«˜ |
| `SESSION_COOKIE_SECURE` | Cookieå®‰å…¨æ ‡å¿— | false | ä¸­ |

**ç« èŠ‚æ¥æº**
- [constants.py](file://enterprise/server/auth/constants.py#L1-L33)

## å®‰å…¨æœ€ä½³å®è·µ

ä¸ºäº†ç¡®ä¿OpenHandsç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå»ºè®®éµå¾ªä»¥ä¸‹æœ€ä½³å®è·µã€‚

### å¯†é’¥ç®¡ç†

```mermaid
graph TB
subgraph "å¯†é’¥ç®¡ç†æµç¨‹"
Generate[ç”Ÿæˆå¯†é’¥] --> Encrypt[åŠ å¯†å­˜å‚¨]
Encrypt --> Rotate[å®šæœŸè½®æ¢]
Rotate --> Audit[å®¡è®¡ç›‘æ§]
end
subgraph "å¯†é’¥ç±»å‹"
JWTSecret[JWTç­¾åå¯†é’¥]
ClientSecret[å®¢æˆ·ç«¯å¯†é’¥]
PrivateKey[ç§é’¥è¯ä¹¦]
WebhookSecret[Webhookå¯†é’¥]
end
Generate --> JWTSecret
Generate --> ClientSecret
Generate --> PrivateKey
Generate --> WebhookSecret
```

### å®‰å…¨é…ç½®å»ºè®®

| é…ç½®é¡¹ | å»ºè®®å€¼ | å®‰å…¨è€ƒè™‘ |
|--------|--------|----------|
| JWTå¯†é’¥é•¿åº¦ | â‰¥32å­—èŠ‚ | é˜²æ­¢æš´åŠ›ç ´è§£ |
| ä»¤ç‰Œè¿‡æœŸæ—¶é—´ | è®¿é—®ä»¤ç‰Œ: 1å°æ—¶ | æœ€å°åŒ–é£é™©çª—å£ |
| åˆ·æ–°ä»¤ç‰Œè¿‡æœŸ | åˆ·æ–°ä»¤ç‰Œ: 30å¤© | å¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨ |
| Cookieå®‰å…¨æ ‡å¿— | HTTPSç¯å¢ƒ: true | é˜²æ­¢CookieåŠ«æŒ |
| SameSiteç­–ç•¥ | Strict | é˜²æ­¢CSRFæ”»å‡» |
| CORSé…ç½® | æ˜ç¡®ç™½åå• | é™åˆ¶è·¨åŸŸè®¿é—® |

### ç›‘æ§å’Œå®¡è®¡

```python
# å…³é”®æ“ä½œçš„æ—¥å¿—è®°å½•
logger.info(
    'user_logged_in',
    extra={
        'idp': identity_provider,
        'idp_type': idp_type,
        'posthog_user_id': posthog_user_id,
        'is_feature_env': IS_FEATURE_ENV,
    },
)
```

### å®šæœŸå®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] æ£€æŸ¥æ‰€æœ‰å¯†é’¥çš„å¼ºåº¦å’Œè½®æ¢å‘¨æœŸ
- [ ] éªŒè¯SSL/TLSè¯ä¹¦çš„æœ‰æ•ˆæ€§
- [ ] å®¡æŸ¥è®¿é—®æ—¥å¿—ä¸­çš„å¼‚å¸¸è¡Œä¸º
- [ ] æ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°å®‰å…¨ç‰ˆæœ¬
- [ ] æµ‹è¯•ç¾éš¾æ¢å¤è®¡åˆ’
- [ ] è¿›è¡Œæ¸—é€æµ‹è¯•è¯„ä¼°
- [ ] å®¡æŸ¥æƒé™åˆ†é…å’Œæœ€å°æƒé™åŸåˆ™
- [ ] æ£€æŸ¥å¤‡ä»½å’Œæ¢å¤æµç¨‹

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥æ˜¾è‘—æé«˜OpenHandsç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯é æ€§ï¼Œä¸ºç”¨æˆ·æä¾›æ›´åŠ å®‰å…¨çš„å¼€å‘ä½“éªŒã€‚