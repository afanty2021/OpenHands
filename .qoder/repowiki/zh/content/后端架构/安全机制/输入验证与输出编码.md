# 输入验证与输出编码

<cite>
**本文档引用的文件**
- [middleware.py](file://openhands/server/middleware.py)
- [utils.py](file://openhands/server/utils.py)
- [saas_conversation_validator.py](file://enterprise/storage/saas_conversation_validator.py)
- [auth_error.py](file://enterprise/server/auth/auth_error.py)
- [conversation.py](file://openhands/server/routes/conversation.py)
- [mcp-server-form.tsx](file://frontend/src/components/features/settings/mcp-settings/mcp-server-form.tsx)
- [mono-component.tsx](file://frontend/src/components/features/chat/mono-component.tsx)
</cite>

## 目录
1. [简介](#简介)
2. [输入验证机制](#输入验证机制)
3. [输出编码与XSS防护](#输出编码与xss防护)
4. [CSRF防护机制](#csrf防护机制)
5. [API端点验证规则](#api端点验证规则)
6. [中间件安全检查](#中间件安全检查)
7. [错误处理策略](#错误处理策略)
8. [自定义验证规则配置](#自定义验证规则配置)

## 简介
OpenHands系统实施了全面的安全机制来防止常见的Web攻击，包括XSS、CSRF和SQL注入。该系统通过多层次的验证和编码策略确保用户输入的安全性，同时保护系统免受恶意攻击。核心安全功能分布在前端和后端组件中，通过严格的输入验证、输出编码和身份验证机制来实现。

**Section sources**
- [middleware.py](file://openhands/server/middleware.py#L1-L132)
- [utils.py](file://openhands/server/utils.py#L1-L116)

## 输入验证机制
OpenHands系统实现了严格的输入验证机制，防止恶意数据进入系统。系统对各种输入参数进行验证，包括会话ID、URL、超时值等。

```mermaid
flowchart TD
Start([输入验证开始]) --> ValidateLength["验证输入长度"]
ValidateLength --> LengthValid{"长度有效?"}
LengthValid --> |否| ReturnError["返回长度错误"]
LengthValid --> |是| ValidateCharacters["验证字符类型"]
ValidateCharacters --> CharactersValid{"字符有效?"}
CharactersValid --> |否| ReturnCharError["返回字符错误"]
CharactersValid --> |是| ValidatePath["验证路径安全"]
ValidatePath --> PathValid{"路径安全?"}
PathValid --> |否| ReturnPathError["返回路径错误"]
PathValid --> |是| ValidateControl["验证控制字符"]
ValidateControl --> ControlValid{"无控制字符?"}
ControlValid --> |否| ReturnControlError["返回控制字符错误"]
ControlValid --> |是| ProcessInput["处理输入"]
ProcessInput --> End([输入验证完成])
ReturnError --> End
ReturnCharError --> End
ReturnPathError --> End
ReturnControlError --> End
```

**Diagram sources**
- [utils.py](file://openhands/server/utils.py#L16-L57)

## 输出编码与XSS防护
系统通过前端和后端的输出编码机制防止XSS攻击。前端组件对HTML实体进行解码，确保安全显示用户内容。

```mermaid
flowchart TD
Start([内容输出开始]) --> CheckHTML["检查HTML实体"]
CheckHTML --> HasEntities{"包含HTML实体?"}
HasEntities --> |是| CreateTextarea["创建临时文本区域"]
CreateTextarea --> SetInnerHTML["设置innerHTML"]
SetInnerHTML --> GetValue["获取解码值"]
GetValue --> OutputContent["输出解码内容"]
HasEntities --> |否| OutputOriginal["输出原始内容"]
OutputContent --> End([内容输出完成])
OutputOriginal --> End
```

**Diagram sources**
- [mono-component.tsx](file://frontend/src/components/features/chat/mono-component.tsx#L4-L8)

## CSRF防护机制
OpenHands系统通过多种机制防止CSRF攻击，包括认证令牌验证和Cookie安全策略。

```mermaid
classDiagram
class SetAuthCookieMiddleware {
+__call__(request, call_next)
+_get_user_auth(request)
+_check_tos(request)
+_should_attach(request)
+_logout(request)
}
class SaasUserAuth {
+refreshed : bool
+access_token : SecretStr
+refresh_token : SecretStr
+accepted_tos : bool
+auth_type : AuthType
+get_user_id()
+get_access_token()
}
class TokenManager {
+get_user_info(access_token)
+logout(refresh_token)
+load_offline_token(user_id)
}
SetAuthCookieMiddleware --> SaasUserAuth : "使用"
SetAuthCookieMiddleware --> TokenManager : "调用"
SaasUserAuth --> TokenManager : "依赖"
```

**Diagram sources**
- [middleware.py](file://enterprise/server/middleware.py#L26-L175)

## API端点验证规则
系统对API端点实施严格的验证规则，确保只有经过验证的请求才能访问敏感资源。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Middleware as "认证中间件"
participant Validator as "会话验证器"
participant Store as "会话存储"
Client->>Middleware : 发送请求(含认证信息)
Middleware->>Middleware : 检查认证头/Cookie
Middleware->>Validator : 调用验证方法
Validator->>Store : 查询会话元数据
Store-->>Validator : 返回验证结果
Validator->>Validator : 检查用户权限
Validator-->>Middleware : 返回用户ID
Middleware->>Middleware : 设置用户认证状态
Middleware-->>Client : 处理请求或返回错误
```

**Diagram sources**
- [saas_conversation_validator.py](file://enterprise/storage/saas_conversation_validator.py#L13-L153)
- [conversation.py](file://openhands/server/routes/conversation.py#L1-L421)

## 中间件安全检查
系统的中间件层执行全面的安全检查，包括CORS策略、速率限制和缓存控制。

```mermaid
flowchart TD
Request([HTTP请求]) --> CORS["CORS检查"]
CORS --> IsLocalhost{"本地主机?"}
IsLocalhost --> |是| AllowLocal["允许本地请求"]
IsLocalhost --> |否| CheckOrigin["检查来源"]
CheckOrigin --> OriginValid{"来源有效?"}
OriginValid --> |否| DenyOrigin["拒绝请求"]
OriginValid --> |是| RateLimit["速率限制检查"]
RateLimit --> WithinLimit{"在限制内?"}
WithinLimit --> |否| Throttle["限流响应"]
WithinLimit --> |是| CacheControl["缓存控制"]
CacheControl --> SetHeaders["设置缓存头"]
SetHeaders --> ProcessRequest["处理请求"]
AllowLocal --> ProcessRequest
DenyOrigin --> ReturnError["返回错误"]
Throttle --> ReturnError
ProcessRequest --> Response["HTTP响应"]
ReturnError --> Response
```

**Diagram sources**
- [middleware.py](file://openhands/server/middleware.py#L16-L132)

## 错误处理策略
系统实施了全面的错误处理策略，确保安全地处理各种认证和验证错误。

```mermaid
classDiagram
class AuthError {
+__init__(detail, headers, status_code)
}
class NoCredentialsError {
+__init__(detail, headers, status_code)
}
class BearerTokenError {
+__init__(detail, headers, status_code)
}
class CookieError {
+__init__(detail, headers, status_code)
}
class TosNotAcceptedError {
+__init__(detail, headers, status_code)
}
class ExpiredError {
+__init__(detail, headers, status_code)
}
AuthError <|-- NoCredentialsError
AuthError <|-- BearerTokenError
AuthError <|-- CookieError
AuthError <|-- TosNotAcceptedError
AuthError <|-- ExpiredError
class JSONResponse {
+status_code : int
+content : dict
+headers : dict
}
NoCredentialsError --> JSONResponse : "返回401"
BearerTokenError --> JSONResponse : "返回401"
CookieError --> JSONResponse : "返回401并删除Cookie"
ExpiredError --> JSONResponse : "返回401并删除Cookie"
```

**Diagram sources**
- [auth_error.py](file://enterprise/server/auth/auth_error.py#L1-L41)

## 自定义验证规则配置
系统允许通过前端表单配置自定义验证规则，如MCP服务器设置。

```mermaid
flowchart TD
FormStart([表单验证开始]) --> CheckServerType["检查服务器类型"]
CheckServerType --> IsSSEorSHTTP{"SSE或SHTTP?"}
IsSSEorSHTTP --> |是| ValidateURL["验证URL格式"]
ValidateURL --> URLOK{"URL有效?"}
URLOK --> |否| ReturnURLError["返回URL错误"]
URLOK --> |是| CheckDuplicate["检查URL重复"]
CheckDuplicate --> Duplicate{"URL重复?"}
Duplicate --> |是| ReturnDuplicateError["返回重复错误"]
Duplicate --> |否| CheckTimeout["检查超时值"]
CheckTimeout --> TimeoutOK{"超时有效?"}
TimeoutOK --> |否| ReturnTimeoutError["返回超时错误"]
TimeoutOK --> |是| ValidateStdio["验证Stdio服务器"]
ValidateStdio --> StdioOK{"Stdio有效?"}
StdioOK --> |否| ReturnStdioError["返回Stdio错误"]
StdioOK --> |是| FormValid["表单有效"]
FormValid --> End([表单验证完成])
ReturnURLError --> End
ReturnDuplicateError --> End
ReturnTimeoutError --> End
ReturnStdioError --> End
```

**Diagram sources**
- [mcp-server-form.tsx](file://frontend/src/components/features/settings/mcp-settings/mcp-server-form.tsx#L161-L183)