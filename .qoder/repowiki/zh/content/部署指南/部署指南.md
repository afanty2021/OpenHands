# 部署指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [docker-compose.yml](file://docker-compose.yml)
- [containers/app/Dockerfile](file://containers/app/Dockerfile)
- [containers/dev/compose.yml](file://containers/dev/compose.yml)
- [kind/cluster.yaml](file://kind/cluster.yaml)
- [kind/manifests/deployment.yaml](file://kind/manifests/deployment.yaml)
- [kind/manifests/nginx.yaml](file://kind/manifests/nginx.yaml)
- [kind/manifests/service.yaml](file://kind/manifests/service.yaml)
- [enterprise/README.md](file://enterprise/README.md)
- [enterprise/enterprise_local/README.md](file://enterprise/enterprise_local/README.md)
- [enterprise/server/config.py](file://enterprise/server/config.py)
- [pyproject.toml](file://pyproject.toml)
- [frontend/src/api/invariant-service.ts](file://frontend/src/api/invariant-service.ts)
- [openhands/runtime/impl/kubernetes/kubernetes_runtime.py](file://openhands/runtime/impl/kubernetes/kubernetes_runtime.py)
</cite>

## 目录
1. [简介](#简介)
2. [本地部署](#本地部署)
3. [云部署](#云部署)
4. [Kubernetes部署](#kubernetes部署)
5. [高可用性配置](#高可用性配置)
6. [监控与日志收集](#监控与日志收集)
7. [备份与恢复策略](#备份与恢复策略)
8. [安全加固建议](#安全加固建议)
9. [部署验证与健康检查](#部署验证与健康检查)

## 简介

OpenHands是一个由AI驱动的软件开发代理平台，支持多种部署模式，包括本地部署、云部署和Kubernetes部署。本指南将详细介绍各种部署场景的配置方法、优缺点和适用场景。

OpenHands的设计初衷是供单个用户在其本地工作站上运行，不适用于多租户部署。对于需要多租户支持的场景，建议使用商业许可的OpenHands Cloud Helm Chart。

**Section sources**
- [README.md](file://README.md#L34-L123)

## 本地部署

### CLI启动器部署（推荐）

使用CLI启动器是本地运行OpenHands最简单的方法，推荐使用uv工具以获得更好的隔离性。

```bash
# 启动GUI服务器
uvx --python 3.12 openhands serve

# 或启动CLI
uvx --python 3.12 openhands
```

应用程序将在[http://localhost:3000](http://localhost:3000)运行。

### Docker部署

通过Docker运行OpenHands：

```bash
docker pull docker.openhands.dev/openhands/runtime:0.61-nikolaik

docker run -it --rm --pull=always \
    -e SANDBOX_RUNTIME_CONTAINER_IMAGE=docker.openhands.dev/openhands/runtime:0.61-nikolaik \
    -e LOG_ALL_EVENTS=true \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v ~/.openhands:/.openhands \
    -p 3000:3000 \
    --add-host host.docker.internal:host-gateway \
    --name openhands-app \
    docker.openhands.dev/openhands/openhands:0.61
```

### docker-compose部署

使用提供的docker-compose.yml文件进行部署：

```yaml
services:
  openhands:
    build:
      context: ./
      dockerfile: ./containers/app/Dockerfile
    image: openhands:latest
    container_name: openhands-app-${DATE:-}
    environment:
      - SANDBOX_RUNTIME_CONTAINER_IMAGE=${SANDBOX_RUNTIME_CONTAINER_IMAGE:-docker.openhands.dev/openhands/runtime:0.61-nikolaik}
      - WORKSPACE_MOUNT_PATH=${WORKSPACE_BASE:-$PWD/workspace}
    ports:
      - "3000:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.openhands:/.openhands
      - ${WORKSPACE_BASE:-$PWD/workspace}:/opt/workspace_base
    pull_policy: build
    stdin_open: true
    tty: true
```

**Section sources**
- [README.md](file://README.md#L56-L114)
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [containers/app/Dockerfile](file://containers/app/Dockerfile#L1-L96)

## 云部署

### OpenHands Cloud

最简单的入门方式是使用OpenHands Cloud，新用户可获得10美元的免费额度。

### 企业版本地开发

对于企业版的本地开发，需要设置特定的环境：

1. 安装gcloud CLI和sops工具
2. 获取GitHub应用密钥：
```bash
gcloud auth application-default login
gcloud config set project global-432717
local/decrypt_env.sh
```

3. 生成.env文件：
```bash
python -m pip install PyYAML
export LITE_LLM_API_KEY=<your LLM API key>
python enterprise_local/convert_to_env.py
```

4. 拉取运行时镜像：
```bash
export SANDBOX_RUNTIME_CONTAINER_IMAGE=ghcr.io/openhands/runtime:main-nikolaik
docker pull $SANDBOX_RUNTIME_CONTAINER_IMAGE
```

**Section sources**
- [README.md](file://README.md#L52-L55)
- [enterprise/README.md](file://enterprise/README.md#L1-L57)
- [enterprise/enterprise_local/README.md](file://enterprise/enterprise_local/README.md#L1-L275)

## Kubernetes部署

### Kind集群部署

使用Kind（Kubernetes in Docker）进行本地Kubernetes部署：

```yaml
# cluster.yaml
---
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: local-hands
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
```

### 部署配置

```yaml
# deployment.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ubuntu-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ubuntu-dev
  template:
    metadata:
      labels:
        app: ubuntu-dev
    spec:
      containers:
        - name: ubuntu
          image: ubuntu:22.04
          command: ["sleep", "infinity"]
```

### 服务配置

```yaml
# service.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: ubuntu-dev
spec:
  selector:
    app: ubuntu-dev
  ports:
    - protocol: TCP
      port: 8099
      targetPort: 3000
```

### Ingress配置

使用nginx-ingress-controller处理外部流量：

```yaml
# nginx.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: openhands-ingress
  namespace: ingress-nginx
spec:
  ingressClassName: nginx
  rules:
  - host: openhands.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: openhands-service
            port:
              number: 3000
```

**Section sources**
- [kind/cluster.yaml](file://kind/cluster.yaml#L1-L10)
- [kind/manifests/deployment.yaml](file://kind/manifests/deployment.yaml#L1-L20)
- [kind/manifests/service.yaml](file://kind/manifests/service.yaml#L1-L13)
- [kind/manifests/nginx.yaml](file://kind/manifests/nginx.yaml#L1-L679)

## 高可用性配置

### 集群化会话管理

OpenHands支持集群化会话管理，通过Redis实现多节点间的通信：

```bash
# 启动Redis
docker run -p 6379:6379 --name openhands-redis -d redis

# 设置环境变量
export REDIS_HOST=host.docker.internal
export REDIS_PORT=6379
```

在企业版配置中，会话管理器类设置为：
```python
conversation_manager_class: str = 'server.clustered_conversation_manager.ClusteredConversationManager'
```

### 负载均衡

使用Kubernetes Service和Ingress实现负载均衡：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: openhands-service
spec:
  selector:
    app: openhands
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: LoadBalancer
```

### 故障转移设置

通过Kubernetes的健康检查和就绪检查实现自动故障转移：

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 10254
  initialDelaySeconds: 10
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /healthz
    port: 10254
  initialDelaySeconds: 10
  periodSeconds: 10
```

**Section sources**
- [enterprise/server/config.py](file://enterprise/server/config.py#L75-L78)
- [kind/manifests/nginx.yaml](file://kind/manifests/nginx.yaml#L454-L486)

## 监控与日志收集

### 监控系统集成

OpenHands支持多种监控系统集成：

1. **Posthog集成**：用于产品分析和用户行为跟踪
```python
posthog_client_key: str = os.environ.get('POSTHOG_CLIENT_KEY', '')
```

2. **OpenTelemetry集成**：用于分布式追踪
```toml
opentelemetry-api = "^1.33.1"
opentelemetry-exporter-otlp-proto-grpc = "^1.33.1"
```

### 日志收集

#### 日志配置

```python
# 企业版服务器配置
class SaaSServerConfig(ServerConfig):
    def get_config(self):
        config = {
            'APP_MODE': self.app_mode,
            'POSTHOG_CLIENT_KEY': self.posthog_client_key,
            # ... 其他配置
        }
        return config
```

#### 日志级别

支持JSON格式和纯文本格式的日志输出：
```bash
# 启用纯文本日志
export LOG_PLAIN_TEXT=1
```

### 告警系统

#### 安全告警

通过Invariant安全分析器集成安全告警：
```typescript
// frontend/src/api/invariant-service.ts
class InvariantService {
  static async getTraces() {
    const { data } = await openHands.get("/api/security/export-trace");
    return data;
  }
}
```

#### 性能告警

使用Prometheus和Grafana进行性能监控，通过Kubernetes的资源限制和请求配置：

```yaml
resources:
  requests:
    cpu: 300m
    memory: 256Mi
  limits:
    memory: 512Mi
```

**Section sources**
- [enterprise/server/config.py](file://enterprise/server/config.py#L65-L70)
- [pyproject.toml](file://pyproject.toml#L61-L63)
- [frontend/src/api/invariant-service.ts](file://frontend/src/api/invariant-service.ts#L1-L30)

## 备份与恢复策略

### 数据持久化

#### 本地存储

```yaml
volumes:
  - ~/.openhands:/.openhands
  - ${WORKSPACE_BASE:-$PWD/workspace}:/opt/workspace_base
```

#### 云存储

支持多种云存储后端：
```python
# 存储位置配置
locations.py文件中定义了多种存储位置
```

### 备份策略

1. **定期备份**：建议每天备份用户数据和会话历史
2. **增量备份**：使用文件系统快照进行增量备份
3. **异地备份**：将备份数据存储在不同地理位置

### 恢复流程

1. 停止OpenHands服务
2. 恢复数据卷
3. 启动服务并验证数据完整性

```bash
# 示例恢复命令
docker run -v backup_volume:/backup -v openhands_data:/data alpine \
  tar -xzf /backup/openhands_backup.tar.gz -C /data
```

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L18-L20)
- [containers/app/Dockerfile](file://containers/app/Dockerfile#L46-L47)

## 安全加固建议

### 网络安全

1. **限制网络绑定**：在公共网络上运行时，限制网络绑定
2. **使用HTTPS**：通过Ingress配置SSL/TLS
3. **防火墙规则**：仅开放必要的端口

### 认证与授权

#### 企业版认证

```python
# 企业版认证配置
class SaaSServerConfig(ServerConfig):
    user_auth_class: str = 'server.auth.saas_user_auth.SaasUserAuth'
```

#### GitHub集成

```python
# GitHub应用配置
github_client_id: str = os.environ.get('GITHUB_APP_CLIENT_ID', '')
GITHUB_APP_PRIVATE_KEY: str
GITHUB_APP_WEBHOOK_SECRET: str
```

### 安全扫描

#### 代码安全

```typescript
// 安全策略API
static async getPolicy() {
  const { data } = await openHands.get("/api/security/policy");
  return data.policy;
}
```

#### 运行时安全

使用SecurityContext限制容器权限：
```yaml
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsGroup: 82
  runAsNonRoot: true
  runAsUser: 101
```

### 合规性考虑

1. **数据隐私**：遵守GDPR等数据隐私法规
2. **审计日志**：保留操作审计日志
3. **访问控制**：实施最小权限原则

**Section sources**
- [enterprise/server/config.py](file://enterprise/server/config.py#L10-L20)
- [kind/manifests/nginx.yaml](file://kind/manifests/nginx.yaml#L494-L503)
- [frontend/src/api/invariant-service.ts](file://frontend/src/api/invariant-service.ts#L4-L7)

## 部署验证与健康检查

### 健康检查清单

#### 服务可用性

- [ ] Web服务在3000端口监听
- [ ] Docker守护进程可访问
- [ ] 存储卷正确挂载

#### 功能验证

- [ ] 用户可以登录
- [ ] LLM集成正常工作
- [ ] 代码执行沙箱正常运行

#### 性能指标

- [ ] 响应时间在可接受范围内
- [ ] 内存使用率正常
- [ ] CPU使用率正常

### 验证脚本

```bash
# 健康检查脚本
curl -f http://localhost:3000/healthz
docker ps | grep openhands
df -h | grep openhands
```

### 故障排查

#### 常见问题

1. **端口冲突**：确保3000端口未被占用
2. **权限问题**：检查Docker权限和文件系统权限
3. **网络问题**：验证Docker网络配置

#### 调试工具

```bash
# 查看日志
docker logs openhands-app

# 进入容器
docker exec -it openhands-app /bin/bash

# 检查网络
docker network inspect bridge
```

**Section sources**
- [README.md](file://README.md#L133-L134)
- [tests/unit/app_server/test_remote_sandbox_service.py](file://tests/unit/app_server/test_remote_sandbox_service.py#L917-L947)