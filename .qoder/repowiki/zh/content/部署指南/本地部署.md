# 本地部署

<cite>
**本文档中引用的文件**  
- [docker-compose.yml](file://docker-compose.yml)
- [containers/app/Dockerfile](file://containers/app/Dockerfile)
- [containers/app/entrypoint.sh](file://containers/app/entrypoint.sh)
- [containers/dev/compose.yml](file://containers/dev/compose.yml)
- [containers/dev/Dockerfile](file://containers/dev/Dockerfile)
- [containers/dev/dev.sh](file://containers/dev/dev.sh)
- [containers/build.sh](file://containers/build.sh)
- [config.template.toml](file://config.template.toml)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [Docker Compose 部署概述](#docker-compose-部署概述)
3. [docker-compose.yml 文件详解](#docker-composeyml-文件详解)
4. [构建和运行容器](#构建和运行容器)
5. [环境变量配置](#环境变量配置)
6. [部署验证](#部署验证)
7. [常见问题排查](#常见问题排查)
8. [性能调优与资源限制](#性能调优与资源限制)
9. [开发环境部署](#开发环境部署)

## 简介

本指南提供使用 Docker Compose 在本地部署 OpenHands 的完整流程。OpenHands 是一个由 AI 驱动的软件开发代理平台，能够执行代码修改、命令运行、网页浏览、API 调用等任务。本指南将详细介绍如何通过 Docker Compose 部署该系统，包括服务定义、网络配置、卷挂载、环境变量设置、端口映射等关键配置项。同时，还将提供部署验证、常见问题排查以及性能调优建议，确保用户能够成功在本地环境中运行 OpenHands。

**Section sources**
- [README.md](file://README.md#L34-L38)

## Docker Compose 部署概述

OpenHands 提供了基于 Docker Compose 的本地部署方案，通过 `docker-compose.yml` 文件定义和配置应用程序的各个服务。该部署方案将 OpenHands 的核心组件打包在 Docker 容器中，利用 Docker 的隔离性和可移植性，确保在不同环境中的一致性。部署过程主要包括拉取或构建镜像、配置环境变量、启动服务容器、挂载必要的卷以及映射端口。

部署的核心是 `docker-compose.yml` 文件，它定义了 `openhands` 服务，该服务基于 `containers/app/Dockerfile` 构建，并配置了必要的环境变量、端口映射和卷挂载。此外，项目还提供了 `containers/dev/compose.yml` 用于开发环境的部署。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)
- [containers/dev/compose.yml](file://containers/dev/compose.yml#L1-L40)

## docker-compose.yml 文件详解

`docker-compose.yml` 文件是 OpenHands 本地部署的核心配置文件，它定义了 `openhands` 服务的构建和运行参数。

### 服务定义

`services` 部分定义了名为 `openhands` 的服务，其主要配置如下：

```yaml
services:
  openhands:
    build:
      context: ./
      dockerfile: ./containers/app/Dockerfile
    image: openhands:latest
    container_name: openhands-app-${DATE:-}
```

- **build**: 指定构建上下文为项目根目录 (`./`)，Dockerfile 位于 `./containers/app/Dockerfile`。这确保了在构建镜像时，Docker 能够访问到所有必要的源代码和依赖文件。
- **image**: 构建完成后，镜像将被标记为 `openhands:latest`。
- **container_name**: 容器的名称为 `openhands-app-` 加上一个可选的日期后缀，这有助于区分不同时间部署的容器实例。

### 环境变量配置

环境变量用于在运行时向容器传递配置信息：

```yaml
environment:
  - SANDBOX_RUNTIME_CONTAINER_IMAGE=${SANDBOX_RUNTIME_CONTAINER_IMAGE:-docker.openhands.dev/openhands/runtime:0.61-nikolaik}
  - WORKSPACE_MOUNT_PATH=${WORKSPACE_BASE:-$PWD/workspace}
```

- **SANDBOX_RUNTIME_CONTAINER_IMAGE**: 指定沙箱运行时使用的容器镜像。如果未在环境变量中设置，则使用默认值 `docker.openhands.dev/openhands/runtime:0.61-nikolaik`。
- **WORKSPACE_MOUNT_PATH**: 指定工作区在主机上的挂载路径。如果未设置 `WORKSPACE_BASE` 环境变量，则默认为当前目录下的 `workspace` 文件夹。

### 端口映射

```yaml
ports:
  - "3000:3000"
```

此配置将主机的 3000 端口映射到容器的 3000 端口。OpenHands 的 Web 服务默认在容器的 3000 端口上运行，因此用户可以通过访问 `http://localhost:3000` 来使用该应用。

### 卷挂载

```yaml
volumes:
  - /var/run/docker.sock:/var/run/docker.sock
  - ~/.openhands:/.openhands
  - ${WORKSPACE_BASE:-$PWD/workspace}:/opt/workspace_base
```

- **/var/run/docker.sock**: 将主机的 Docker 套接字挂载到容器内，使容器内的 OpenHands 能够与主机的 Docker 守护进程通信，从而创建和管理其他容器（如沙箱环境）。
- **~/.openhands:/.openhands**: 将用户主目录下的 `.openhands` 目录挂载到容器内的 `/.openhands`，用于持久化存储用户配置、会话数据等。
- **${WORKSPACE_BASE:-$PWD/workspace}:/opt/workspace_base**: 将主机上的工作区目录（默认为 `./workspace`）挂载到容器内的 `/opt/workspace_base`，使 OpenHands 能够访问和修改本地文件。

### 网络配置

```yaml
extra_hosts:
  - "host.docker.internal:host-gateway"
```

此配置将 `host.docker.internal` 主机名解析到 `host-gateway`，这在 Docker Desktop 环境中是必需的，它允许容器内的服务访问主机上的服务。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L24)

## 构建和运行容器

### 使用预构建镜像

最简单的部署方式是直接使用预构建的 Docker 镜像。根据 `README.md` 中的说明，可以使用以下命令：

```bash
docker pull docker.openhands.dev/openhands/runtime:0.61-nikolaik
docker run -it --rm --pull=always \
    -e SANDBOX_RUNTIME_CONTAINER_IMAGE=docker.openhands.dev/openhands/runtime:0.61-nikolaik \
    -e LOG_ALL_EVENTS=true \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v ~/.openhands:/.openhands \
    -p 3000:3000 \
    --add-host host.docker.internal:host-gateway \
    --name openhands-app \
    docker.openhands.dev/openhands/openhands:0.61
```

此命令会拉取最新的运行时镜像，并启动一个 OpenHands 容器。

### 使用 docker-compose 命令

更推荐的方式是使用 `docker-compose` 命令，它会自动处理镜像的构建和容器的启动：

```bash
# 构建镜像并启动服务
docker-compose up --build

# 在后台运行
docker-compose up -d --build
```

`--build` 参数确保在启动前重新构建镜像，这对于使用最新代码进行部署非常有用。

### 手动构建镜像

如果需要手动构建镜像，可以使用 `containers/build.sh` 脚本：

```bash
# 构建 openhands 镜像
./containers/build.sh -i openhands
```

该脚本会根据 `containers/app/config.sh` 中的配置，使用 `docker buildx` 命令构建镜像，并支持多平台构建。

**Section sources**
- [README.md](file://README.md#L84-L96)
- [containers/build.sh](file://containers/build.sh#L1-L183)

## 环境变量配置

环境变量是配置 OpenHands 行为的关键。除了在 `docker-compose.yml` 中定义的变量外，还可以通过 `.env` 文件或命令行直接传递。

### 关键环境变量

| 环境变量 | 描述 | 默认值 |
| :--- | :--- | :--- |
| `SANDBOX_RUNTIME_CONTAINER_IMAGE` | 沙箱运行时使用的容器镜像 | `docker.openhands.dev/openhands/runtime:0.61-nikolaik` |
| `WORKSPACE_BASE` | 主机上工作区的基础路径 | `$PWD/workspace` |
| `SANDBOX_USER_ID` | 沙箱内运行代码的用户 ID | `0` (root) |
| `LOG_ALL_EVENTS` | 是否记录所有事件 | `false` |

### 配置文件

项目根目录下的 `config.template.toml` 文件提供了所有可配置选项的模板。用户可以复制此文件为 `config.toml` 并根据需要进行修改。该文件使用 TOML 格式，包含了核心、LLM、代理、沙箱、安全等多个模块的详细配置。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L9-L12)
- [config.template.toml](file://config.template.toml#L1-L543)

## 部署验证

部署成功后，需要进行验证以确保所有组件正常工作。

### 健康检查

OpenHands 提供了健康检查端点 `/ready`，可以通过以下命令测试：

```bash
curl http://localhost:3000/ready
```

如果返回 `OK`，则表示服务已准备好。

### 基本功能测试

1. 访问 `http://localhost:3000`，确认 Web 界面能够正常加载。
2. 在界面中选择一个 LLM 提供商（如 Anthropic 的 Claude Sonnet）并输入 API 密钥。
3. 创建一个新会话，尝试让代理执行一个简单的任务，例如“在当前目录创建一个名为 `test.txt` 的文件”。
4. 检查 `./workspace` 目录，确认文件是否被成功创建。

这些测试可以验证前端、后端、沙箱环境以及文件系统挂载是否正常工作。

**Section sources**
- [enterprise/server/routes/readiness.py](file://enterprise/server/routes/readiness.py#L1-L35)

## 常见问题排查

### 端口冲突

如果主机的 3000 端口已被占用，`docker-compose up` 命令会失败。解决方法是修改 `docker-compose.yml` 中的端口映射：

```yaml
ports:
  - "3001:3000" # 将主机端口改为 3001
```

然后通过 `http://localhost:3001` 访问服务。

### 权限问题

最常见的权限问题是 Docker 套接字的访问权限。确保运行 `docker` 命令的用户属于 `docker` 用户组：

```bash
sudo usermod -aG docker $USER
```

之后需要重新登录或重启系统以使更改生效。

另一个问题是工作区目录的权限。如果挂载的目录权限设置不当，可能导致容器内的进程无法读写文件。确保 `./workspace` 目录对所有用户可读写，或在 `entrypoint.sh` 中正确配置用户权限。

### 网络连接故障

如果容器无法访问 `host.docker.internal`，请检查 Docker 的版本和配置。在某些 Linux 发行版上，可能需要手动添加 `extra_hosts` 配置或使用 `--network=host` 模式。

如果沙箱容器无法访问互联网，检查主机的网络设置和防火墙规则。

**Section sources**
- [containers/app/entrypoint.sh](file://containers/app/entrypoint.sh#L1-L74)
- [README.md](file://README.md#L103-L104)

## 性能调优与资源限制

为了优化 OpenHands 的性能并防止资源耗尽，可以进行以下配置。

### 资源限制

虽然 `docker-compose.yml` 文件中没有直接设置资源限制，但可以在 `docker-compose.override.yml` 文件中添加：

```yaml
services:
  openhands:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M
```

这将限制容器最多使用 2 个 CPU 核心和 4GB 内存。

### 沙箱配置

在 `config.toml` 文件中，可以配置沙箱的超时时间和资源使用：

```toml
[sandbox]
timeout = 120 # 沙箱超时时间（秒）
enable_gpu = false # 是否启用 GPU 支持
```

### 缓存优化

`containers/dev/compose.yml` 中定义了一个名为 `cache-data` 的卷，用于缓存 Python 和 Node.js 的依赖：

```yaml
volumes:
  cache-data:

services:
  dev:
    volumes:
      - cache-data:/root/.cache
```

这可以显著加快开发环境的构建和启动速度。

**Section sources**
- [containers/dev/compose.yml](file://containers/dev/compose.yml#L38-L40)
- [config.template.toml](file://config.template.toml#L292-L348)

## 开发环境部署

对于开发者，项目提供了专门的开发环境配置。通过运行 `containers/dev/dev.sh` 脚本，可以启动一个包含完整开发工具链的容器：

```bash
./containers/dev/dev.sh
```

此脚本会：
1. 检查 Docker 是否已安装。
2. 设置必要的环境变量（如 `SANDBOX_USER_ID` 为当前用户的 ID）。
3. 使用 `containers/dev/compose.yml` 启动 `dev` 服务。

`dev` 服务基于 `containers/dev/Dockerfile` 构建，该文件安装了 `git`、`gh`、`nodejs`、`python3.12`、`poetry` 等开发工具，并将项目源码挂载到容器内的 `/app` 目录，便于进行代码修改和调试。

**Section sources**
- [containers/dev/dev.sh](file://containers/dev/dev.sh#L1-L40)
- [containers/dev/Dockerfile](file://containers/dev/Dockerfile#L1-L128)