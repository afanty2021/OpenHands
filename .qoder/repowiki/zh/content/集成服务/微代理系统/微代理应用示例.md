# 微代理应用示例

<cite>
**本文档中引用的文件**  
- [microagents/README.md](file://microagents/README.md)
- [microagents/github.md](file://microagents/github.md)
- [microagents/gitlab.md](file://microagents/gitlab.md)
- [microagents/code-review.md](file://microagents/code-review.md)
- [microagents/security.md](file://microagents/security.md)
- [microagents/address_pr_comments.md](file://microagents/address_pr_comments.md)
- [microagents/update_pr_description.md](file://microagents/update_pr_description.md)
- [microagents/fix-py-line-too-long.md](file://microagents/fix-py-line-too-long.md)
- [microagents/default-tools.md](file://microagents/default-tools.md)
- [microagents/docker.md](file://microagents/docker.md)
- [microagents/npm.md](file://microagents/npm.md)
- [microagents/kubernetes.md](file://microagents/kubernetes.md)
- [microagents/ssh.md](file://microagents/ssh.md)
</cite>

## 目录
1. [简介](#简介)
2. [微代理架构与类型](#微代理架构与类型)
3. [GitHub集成场景](#github集成场景)
4. [GitLab集成场景](#gitlab集成场景)
5. [代码审查微代理](#代码审查微代理)
6. [安全扫描微代理](#安全扫描微代理)
7. [PR评论处理微代理](#pr评论处理微代理)
8. [PR描述更新微代理](#pr描述更新微代理)
9. [其他集成场景](#其他集成场景)
10. [配置参数与最佳实践](#配置参数与最佳实践)

## 简介

微代理是OpenHands平台中的专用提示系统，旨在通过领域特定知识和任务特定工作流增强开发体验。它们帮助开发者提供专家指导、自动化常见任务，并确保项目间的一致性实践。每个微代理都针对特定领域进行优化，从Git操作到代码审查流程。

微代理系统支持两种主要类型：知识代理（Knowledge Agents）和仓库代理（Repository Agents）。知识代理基于关键词触发，提供跨项目的可重用知识；仓库代理则为特定仓库提供私有指导，自动加载并强制执行团队规范。

**Section sources**
- [microagents/README.md](file://microagents/README.md#L1-L138)

## 微代理架构与类型

微代理系统采用模块化设计，支持灵活的触发机制和配置选项。系统从两个主要来源加载微代理：

### 知识代理

知识代理提供基于关键词触发的专业知识，适用于跨项目的通用最佳实践。这些代理在对话中检测到特定关键词时被激活，例如"git"、"docker"或"security"。

关键特性包括：
- **触发式激活**：基于对话中的关键词自动激活
- **上下文感知**：根据文件类型和内容提供相关建议
- **可重用性**：知识可在多个项目间共享
- **版本控制**：支持工具/框架的多个版本

### 仓库代理

仓库代理提供特定于仓库的知识和指南，从`.openhands/microagents/repo.md`加载。这些代理具有仓库私有性，自动为对应仓库激活，非常适合团队实践和项目约定。

关键特性包括：
- **项目特定性**：包含仓库独有的指南
- **团队导向**：强制执行团队约定和实践
- **始终激活**：为仓库自动加载
- **本地维护**：随项目更新而更新

微代理使用包含YAML前言的Markdown文件实现，支持版本控制、触发器定义和输入参数验证等高级功能。

**Section sources**
- [microagents/README.md](file://microagents/README.md#L50-L85)

## GitHub集成场景

GitHub微代理为开发者提供与GitHub API交互的完整指南，确保通过API而非浏览器进行所有操作。

### 核心功能

GitHub微代理的关键功能包括：
- 使用`GITHUB_TOKEN`环境变量进行身份验证
- 通过`curl`命令与GitHub API交互
- 使用`create_pr`工具创建拉取请求
- 处理认证问题时更新远程URL

### 工作模式

微代理遵循严格的工作流程：
1. **分支管理**：绝不直接推送到`main`或`master`分支
2. **分支创建**：从`openhands-workspace`分支创建新分支
3. **PR创建**：使用`create_pr`工具创建拉取请求
4. **持续更新**：在现有分支和PR上持续更新，不创建新的
5. **用户通知**：在创建或更新PR后向用户发送链接

### 安全实践

微代理强调安全最佳实践：
- 使用HTTPS URL包含令牌进行推送
- 预设的git配置（用户名和邮箱）不得修改
- 在尽可能少的步骤中完成操作

```mermaid
flowchart TD
A[开始] --> B{用户请求操作}
B --> C[检查当前分支]
C --> D[创建新分支]
D --> E[提交更改]
E --> F[推送分支]
F --> G[创建PR]
G --> H[通知用户]
H --> I[结束]
```

**Diagram sources**
- [microagents/github.md](file://microagents/github.md#L1-L36)

**Section sources**
- [microagents/github.md](file://microagents/github.md#L1-L36)

## GitLab集成场景

GitLab微代理提供与GitLab API交互的完整指南，与GitHub微代理类似但针对GitLab特定功能。

### 核心功能

GitLab微代理的关键功能包括：
- 使用`GITLAB_TOKEN`环境变量进行身份验证
- 通过`curl`命令与GitLab API交互
- 使用`create_mr`工具创建合并请求
- 处理认证问题时更新远程URL

### 工作模式

微代理遵循与GitHub类似但适应GitLab的工作流程：
1. **分支管理**：绝不直接推送到`main`或`master`分支
2. **分支创建**：从`openhands-workspace`分支创建新分支
3. **MR创建**：使用`create_mr`工具创建合并请求
4. **持续更新**：在现有分支和MR上持续更新
5. **用户通知**：在创建或更新MR后向用户发送链接

### 认证差异

与GitHub的主要区别在于认证URL格式：
- GitLab使用`https://oauth2:${GITLAB_TOKEN}@gitlab.com/username/repo.git`格式
- 这反映了GitLab的OAuth2认证机制

```mermaid
flowchart TD
A[开始] --> B{用户请求操作}
B --> C[检查当前分支]
C --> D[创建新分支]
D --> E[提交更改]
E --> F[推送分支]
F --> G[创建MR]
G --> H[通知用户]
H --> I[结束]
```

**Diagram sources**
- [microagents/gitlab.md](file://microagents/gitlab.md#L1-L35)

**Section sources**
- [microagents/gitlab.md](file://microagents/gitlab.md#L1-L35)

## 代码审查微代理

代码审查微代理是一个专门用于代码质量评估的工具，通过`/codereview`命令触发。

### 审查角色

微代理扮演专家软件工程师和代码审查者的角色，具有现代编程最佳实践、安全编码和整洁代码原则的深厚经验。

### 审查场景

微代理在以下场景中提供反馈：
- **风格和格式**：检查缩进、间距、括号使用、未使用导入等
- **清晰度和可读性**：识别复杂逻辑、单一职责违反、命名不当等
- **安全和常见错误模式**：检测未净化的用户输入、硬编码凭据、加密库误用等

### 反馈格式

微代理使用结构化格式提供反馈：
- 包含文件路径和行号
- 使用表情符号标识问题类型
- 提供具体改进建议

示例格式：
```
[src/utils.py, 第42行] :hammer_and_wrench: 未使用的导入：'os'模块已导入但从未使用。请移除以清理代码。
[src/database.py, 第78–85行] :mag: 可读性：此嵌套if-else块难以理解。考虑重构为更小的函数或使用早期返回。
[src/auth.py, 第102行] :closed_lock_with_key: 安全风险：用户输入直接连接到SQL查询中。这可能导致SQL注入。请使用参数化查询。
```

**Section sources**
- [microagents/code-review.md](file://microagents/code-review.md#L1-L55)

## 安全扫描微代理

安全微代理提供全面的安全最佳实践指导，通过"security"、"vulnerability"等关键词触发。

### 核心安全原则

微代理强调以下核心原则：
- 始终使用安全通信协议（HTTPS、SSH等）
- 绝不将敏感数据（密码、令牌、密钥）存储在代码或版本控制中
- 应用最小权限原则
- 验证和净化所有用户输入

### 常见安全检查

微代理执行以下安全检查：
- 确保适当的认证和授权机制
- 验证安全的会话管理
- 确认敏感数据的安全存储
- 验证服务和API的安全配置

### 错误处理

微代理强调安全的错误处理实践：
- 绝不在错误消息中暴露敏感信息
- 适当地记录安全事件
- 实现适当的异常处理
- 使用安全的错误报告机制

微代理在开发过程中始终考虑安全影响，并在可能的情况下内联解决安全问题，或通过代码注释、PR评论等适当渠道进行沟通。

**Section sources**
- [microagents/security.md](file://microagents/security.md#L1-L35)

## PR评论处理微代理

PR评论处理微代理通过`/address_pr_comments`命令触发，专门用于处理拉取请求中的评论。

### 输入参数

微代理需要以下输入参数：
- **PR_URL**：拉取请求的URL
- **BRANCH_NAME**：对应拉取请求的分支名称

### 工作流程

微代理执行以下工作流程：
1. 检查指定分支并阅读与主分支的差异以理解目的
2. 使用GitHub API读取此PR的审查和评论
3. 针对性地解决所有评论中提出的问题

该微代理实现了自动化反馈循环，确保所有PR评论都得到适当处理，提高了代码审查效率。

**Section sources**
- [microagents/address_pr_comments.md](file://microagents/address_pr_comments.md#L1-L20)

## PR描述更新微代理

PR描述更新微代理通过`/update_pr_description`命令触发，用于更新拉取请求描述。

### 输入参数

微代理需要以下输入参数：
- **PR_URL**：拉取请求的URL（需通过正则表达式验证）
- **BRANCH_NAME**：对应拉取请求的分支名称

### 工作流程

微代理执行以下工作流程：
1. 检查指定分支并查看与主分支的差异
2. 使用GitHub API读取现有PR描述
3. 根据代码变更更新描述，使其更准确地反映所做的更改

该微代理确保PR描述始终保持最新状态，提高代码审查的透明度和效率。

**Section sources**
- [microagents/update_pr_description.md](file://microagents/update_pr_description.md#L1-L22)

## 其他集成场景

除了主要的代码托管平台集成，微代理系统还支持多种其他工具和技术的集成。

### Docker集成

Docker微代理提供Docker使用指南，通过"docker"或"container"关键词触发。它指导用户：
- 在容器环境中启动Docker守护进程
- 验证Docker安装是否正确
- 运行hello-world容器进行测试

### NPM集成

NPM微代理通过"npm"关键词触发，解决NPM包安装中的交互问题。它建议使用Unix的"yes"命令输出来确认操作，避免交互式shell的限制。

### Kubernetes集成

Kubernetes微代理通过"kubernetes"、"k8s"或"kube"关键词触发，提供本地Kubernetes开发指南。它包括：
- KIND（Kubernetes IN Docker）的安装和设置
- kubectl的安装
- 本地集群的创建

### SSH集成

SSH微代理提供建立和管理远程机器SSH连接的能力，通过"ssh"、"remote server"等关键词触发。它支持：
- 密码或基于密钥的身份验证
- SSH密钥对的生成和管理
- SSH配置以简化连接
- 在远程机器上执行命令
- 本地和远程机器之间的文件传输

这些集成场景展示了微代理系统的灵活性和可扩展性，能够适应各种开发工具和技术栈。

**Section sources**
- [microagents/docker.md](file://microagents/docker.md#L1-L32)
- [microagents/npm.md](file://microagents/npm.md#L1-L12)
- [microagents/kubernetes.md](file://microagents/kubernetes.md#L1-L51)
- [microagents/ssh.md](file://microagents/ssh.md#L1-L138)

## 配置参数与最佳实践

微代理系统支持丰富的配置选项，为开发者提供可复用的模式和最佳实践。

### YAML前言配置

微代理使用YAML前言定义关键属性：
- **name**：微代理名称
- **type**：类型（知识或仓库）
- **version**：版本号
- **agent**：关联的代理类型
- **triggers**：激活关键词列表
- **inputs**：输入参数定义，包括名称、描述、类型和验证规则

### 最佳实践

#### 知识代理最佳实践
- 选择独特的触发器
- 专注于一个专业领域
- 包含实用示例
- 在相关时使用文件模式
- 保持知识的通用性和可重用性

#### 仓库代理最佳实践
- 记录清晰的设置说明
- 包含仓库结构细节
- 指定测试和构建程序
- 列出环境要求
- 记录CI工作流和检查
- 包含代码质量标准信息
- 维护最新的团队实践

### 贡献指南

贡献者应在以下情况下创建微代理：
- **知识代理**：拥有语言/框架最佳实践、工具使用模式、常见问题解决方案或通用开发指南
- **仓库代理**：需要项目特定指南、团队约定、自定义工作流文档或仓库特定设置说明

提交流程包括在适当目录创建代理文件、彻底测试，然后提交拉取请求。

**Section sources**
- [microagents/README.md](file://microagents/README.md#L106-L133)
- [microagents/fix-py-line-too-long.md](file://microagents/fix-py-line-too-long.md#L1-L40)
- [microagents/default-tools.md](file://microagents/default-tools.md#L1-L16)