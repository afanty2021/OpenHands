# 运行时插件系统

<cite>
**本文档中引用的文件**  
- [requirement.py](file://openhands/runtime/plugins/requirement.py)
- [agent_skills.py](file://openhands/runtime/plugins/agent_skills/agentskills.py)
- [file_ops.py](file://openhands/runtime/plugins/agent_skills/file_ops/file_ops.py)
- [repo_ops.py](file://openhands/runtime/plugins/agent_skills/repo_ops/repo_ops.py)
- [jupyter/__init__.py](file://openhands/runtime/plugins/jupyter/__init__.py)
- [jupyter/execute_server.py](file://openhands/runtime/plugins/jupyter/execute_server.py)
- [vscode/__init__.py](file://openhands/runtime/plugins/vscode/__init__.py)
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py)
- [__init__.py](file://openhands/runtime/plugins/__init__.py)
</cite>

## 目录
1. [插件架构概述](#插件架构概述)
2. [Agent Skills插件系统](#agent-skills插件系统)
3. [Jupyter插件机制](#jupyter插件机制)
4. [VSCode插件支持](#vscode插件支持)
5. [插件加载与依赖管理](#插件加载与依赖管理)
6. [安全沙箱机制](#安全沙箱机制)
7. [自定义插件开发指南](#自定义插件开发指南)

## 插件架构概述

OpenHands运行时插件系统提供了一个可扩展的架构，允许在沙箱环境中集成各种功能。插件系统基于抽象基类设计，所有插件都必须继承`Plugin`基类并实现必要的方法。

```mermaid
classDiagram
class Plugin {
<<abstract>>
+str name
+initialize(username : str)
+run(action : Action)
}
class PluginRequirement {
+str name
+str documentation
}
class JupyterPlugin {
+int kernel_gateway_port
+str kernel_id
+initialize(username : str, kernel_id : str)
+run(action : Action)
}
class AgentSkillsPlugin {
+initialize(username : str)
+run(action : Action)
}
class VSCodePlugin {
+int vscode_port
+str vscode_connection_token
+initialize(username : str)
+run(action : Action)
}
Plugin <|-- JupyterPlugin
Plugin <|-- AgentSkillsPlugin
Plugin <|-- VSCodePlugin
PluginRequirement <.. Plugin
```

**插件来源**  
- [requirement.py](file://openhands/runtime/plugins/requirement.py#L8-L24)
- [__init__.py](file://openhands/runtime/plugins/__init__.py#L21-L25)

## Agent Skills插件系统

Agent Skills插件为智能体提供了丰富的文件操作、代码编辑和仓库管理能力。该插件通过导入多个子模块来提供完整的功能集。

### 文件操作技能

Agent Skills插件提供了全面的文件操作功能，包括文件浏览、搜索和导航。这些功能通过`file_ops`模块实现，为智能体提供了类似IDE的文件操作体验。

```mermaid
classDiagram
class FileOperations {
+open_file(path : str, line_number : int, context_lines : int)
+goto_line(line_number : int)
+scroll_down()
+scroll_up()
+search_dir(search_term : str, dir_path : str)
+search_file(search_term : str, file_path : str)
+find_file(file_name : str, dir_path : str)
}
class FileReader {
+read_file(file_path : str)
+read_lines(file_path : str, start : int, end : int)
}
class FileEditor {
+file_editor(command : str, path : str, file_text : str, old_str : str, new_str : str, insert_line : int)
}
class RepoOperations {
+get_entity_contents(entity_name : str)
+search_code_snippets(search_term : str)
+explore_tree_structure()
}
FileOperations <.. AgentSkillsPlugin
FileReader <.. AgentSkillsPlugin
FileEditor <.. AgentSkillsPlugin
RepoOperations <.. AgentSkillsPlugin
```

**插件来源**  
- [file_ops.py](file://openhands/runtime/plugins/agent_skills/file_ops/file_ops.py#L183-L403)
- [agentskills.py](file://openhands/runtime/plugins/agent_skills/agentskills.py#L3-L45)

### 代码编辑功能

代码编辑功能通过集成`openhands_aci.editor`模块实现，提供了强大的代码编辑能力。`file_editor`函数是主要的编辑接口，支持多种编辑命令。

```mermaid
flowchart TD
Start["代码编辑请求"] --> ValidateInput["验证输入参数"]
ValidateInput --> CheckFile["检查文件是否存在"]
CheckFile --> ReadFile["读取文件内容"]
ReadFile --> ApplyEdit["应用编辑操作"]
ApplyEdit --> LintCheck["执行语法检查"]
LintCheck --> SaveFile["保存修改后的文件"]
SaveFile --> GenerateDiff["生成差异报告"]
GenerateDiff --> ReturnResult["返回编辑结果"]
LintCheck --> |存在语法错误| ReturnError["返回错误信息"]
```

**插件来源**  
- [file_editor.py](file://openhands/runtime/plugins/agent_skills/file_editor/__init__.py#L6)
- [file_ops.py](file://openhands/runtime/plugins/agent_skills/file_ops/file_ops.py#L88-L111)

### 仓库管理技能

仓库管理技能通过`repo_ops`模块提供，集成了代码索引和搜索功能。这些功能基于`openhands_aci.indexing.locagent.tools`模块实现。

```mermaid
classDiagram
class RepoOperations {
+explore_tree_structure()
+get_entity_contents(entity_name : str)
+search_code_snippets(search_term : str)
}
class CodeIndexer {
+build_index(repository_path : str)
+search_entities(query : str)
+get_entity_details(entity_name : str)
}
class SearchEngine {
+full_text_search(query : str)
+semantic_search(query : str)
+code_pattern_search(pattern : str)
}
RepoOperations --> CodeIndexer
RepoOperations --> SearchEngine
```

**插件来源**  
- [repo_ops.py](file://openhands/runtime/plugins/agent_skills/repo_ops/repo_ops.py#L1-L12)
- [agentskills.py](file://openhands/runtime/plugins/agent_skills/agentskills.py#L15-L25)

## Jupyter插件机制

Jupyter插件提供了内核集成和代码执行能力，允许在沙箱环境中执行Python代码并获取执行结果。

### 内核集成架构

Jupyter插件通过启动Jupyter内核网关来实现代码执行功能。该插件负责管理内核生命周期，包括启动、初始化和关闭。

```mermaid
sequenceDiagram
participant Runtime as 运行时
participant JupyterPlugin as Jupyter插件
participant KernelGateway as 内核网关
participant JupyterKernel as Jupyter内核
Runtime->>JupyterPlugin : initialize()
JupyterPlugin->>JupyterPlugin : find_available_tcp_port()
JupyterPlugin->>KernelGateway : 启动内核网关进程
KernelGateway-->>JupyterPlugin : 网关就绪
JupyterPlugin->>JupyterKernel : 创建内核实例
JupyterPlugin->>JupyterKernel : initialize()
JupyterKernel->>KernelGateway : 创建内核会话
KernelGateway-->>JupyterKernel : 内核ID
JupyterKernel->>JupyterKernel : 设置心跳机制
JupyterKernel-->>JupyterPlugin : 内核初始化完成
JupyterPlugin-->>Runtime : 插件初始化完成
Runtime->>JupyterPlugin : run(IPythonRunCellAction)
JupyterPlugin->>JupyterKernel : execute(code)
JupyterKernel->>KernelGateway : 发送执行请求
KernelGateway-->>JupyterKernel : 执行结果
JupyterKernel-->>JupyterPlugin : 结构化输出
JupyterPlugin-->>Runtime : IPythonRunCellObservation
```

**插件来源**  
- [jupyter/__init__.py](file://openhands/runtime/plugins/jupyter/__init__.py#L38-L181)
- [execute_server.py](file://openhands/runtime/plugins/jupyter/execute_server.py#L53-L309)

### 代码执行流程

代码执行流程涉及多个组件的协同工作，确保代码在安全的环境中执行并返回结构化结果。

```mermaid
flowchart TD
A["接收IPythonRunCellAction"] --> B["验证操作类型"]
B --> C{"内核已初始化?"}
C --> |否| D["初始化Jupyter内核"]
D --> E["连接到内核网关"]
E --> F["创建内核会话"]
F --> G["设置心跳机制"]
G --> H["内核初始化完成"]
C --> |是| I["准备执行代码"]
I --> J["生成唯一消息ID"]
J --> K["构建执行请求"]
K --> L["通过WebSocket发送请求"]
L --> M["等待执行结果"]
M --> N{"收到消息类型"}
N --> |execute_reply| O["检查执行状态"]
O --> |成功| P["提取文本输出"]
P --> Q["提取图像URLs"]
Q --> R["构建IPythonRunCellObservation"]
R --> S["返回观察结果"]
O --> |失败| T["提取错误信息"]
T --> U["构建错误观察"]
U --> S
N --> |stream| V["收集流输出"]
V --> M
N --> |display_data| W["提取显示数据"]
W --> M
```

**插件来源**  
- [execute_server.py](file://openhands/runtime/plugins/jupyter/execute_server.py#L142-L258)
- [jupyter/__init__.py](file://openhands/runtime/plugins/jupyter/__init__.py#L151-L181)

## VSCode插件支持

VSCode插件提供了远程开发支持，允许用户通过浏览器访问VSCode开发环境。

### 远程开发架构

VSCode插件通过启动OpenVSCode Server来提供远程开发功能。该插件负责配置VSCode环境并启动服务器进程。

```mermaid
classDiagram
class VSCodePlugin {
+int vscode_port
+str vscode_connection_token
+_setup_vscode_settings()
+initialize(username : str)
+run(action : Action)
}
class OpenVSCodeServer {
+int port
+str connection_token
+workspace_path : str
+base_path : str
+start_server()
+stop_server()
}
class VSCodeSettings {
+settings.json
+extensions.json
+keybindings.json
}
VSCodePlugin --> OpenVSCodeServer
VSCodePlugin --> VSCodeSettings
VSCodeSettings --> ".vscode目录"
```

**插件来源**  
- [vscode/__init__.py](file://openhands/runtime/plugins/vscode/__init__.py#L50-L157)

### 配置与初始化

VSCode插件的初始化过程包括设置VSCode配置文件和启动服务器进程。

```mermaid
flowchart TD
A["调用initialize方法"] --> B{"用户权限检查"}
B --> |非root用户| C["禁用VSCode插件"]
B --> |root用户| D["设置VSCode配置"]
D --> E["读取settings.json模板"]
E --> F["创建.vscode目录"]
F --> G["复制配置文件"]
G --> H["设置文件权限"]
H --> I["获取VSCode端口"]
I --> J{"端口可用?"}
J --> |否| K["禁用VSCode插件"]
J --> |是| L["生成连接令牌"]
L --> M["构建启动命令"]
M --> N["启动OpenVSCode Server"]
N --> O["等待服务器就绪"]
O --> P["插件初始化完成"]
```

**插件来源**  
- [vscode/__init__.py](file://openhands/runtime/plugins/vscode/__init__.py#L59-L132)

## 插件加载与依赖管理

插件系统通过配置驱动的方式管理插件的加载和依赖关系，确保插件按正确顺序初始化。

### 插件加载机制

插件加载机制在`ActionExecutor`初始化时执行，根据配置加载指定的插件并进行初始化。

```mermaid
sequenceDiagram
participant Config as 配置
participant ActionExecutor as 操作执行器
participant PluginManager as 插件管理器
participant Plugin as 插件实例
Config->>ActionExecutor : plugins_to_load
ActionExecutor->>ActionExecutor : __init__()
ActionExecutor->>PluginManager : wait_all(初始化所有插件)
PluginManager->>Plugin : initialize(username)
Plugin-->>PluginManager : 初始化完成
PluginManager->>ActionExecutor : 所有插件初始化完成
ActionExecutor->>ActionExecutor : _init_bash_commands()
ActionExecutor-->>Config : 运行时客户端初始化完成
Note over PluginManager,ActionExecutor : 并行初始化所有插件
```

**插件来源**  
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py#L301-L327)
- [command.py](file://openhands/runtime/utils/command.py#L21-L82)

### 依赖管理策略

依赖管理通过命令行参数和环境变量实现，确保插件之间的正确依赖关系。

```mermaid
flowchart TD
A["获取插件配置"] --> B["解析插件列表"]
B --> C["构建启动命令"]
C --> D["添加插件参数"]
D --> E["--plugins jupyter agent_skills vscode"]
E --> F["设置环境变量"]
F --> G["INIT_PLUGIN_TIMEOUT"]
G --> H["JUPYTER_GATEWAY_PORT"]
H --> I["VSCODE_PORT"]
I --> J["构建完整命令"]
J --> K["执行启动命令"]
K --> L["初始化插件系统"]
```

**插件来源**  
- [command.py](file://openhands/runtime/utils/command.py#L40-L43)
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py#L68)

## 安全沙箱机制

运行时插件系统运行在安全的沙箱环境中，通过多种机制确保执行安全。

### 沙箱隔离策略

沙箱环境通过容器化技术实现隔离，限制插件的系统访问权限。

```mermaid
classDiagram
class SandboxEnvironment {
+限制文件系统访问
+限制网络访问
+限制系统调用
+资源使用限制
+用户权限隔离
}
class PluginExecution {
+在指定工作目录执行
+使用非特权用户运行
+限制内存使用
+限制CPU使用
+限制执行时间
}
class SecurityMonitoring {
+执行操作审计
+资源使用监控
+异常行为检测
+安全风险评估
}
SandboxEnvironment --> PluginExecution
SandboxEnvironment --> SecurityMonitoring
```

**插件来源**  
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py#L171-L200)
- [runtime_init.py](file://openhands/runtime/utils/runtime_init.py)

### 安全风险控制

系统通过安全风险评估机制控制潜在的安全威胁。

```mermaid
flowchart TD
A["接收操作请求"] --> B["评估安全风险"]
B --> C{"高风险操作?"}
C --> |是| D["记录安全警告"]
D --> E["执行操作"]
E --> F["监控执行结果"]
F --> G["生成安全报告"]
C --> |否| H["直接执行操作"]
H --> I["返回观察结果"]
G --> J["存储安全日志"]
I --> J
J --> K["完成操作执行"]
```

**插件来源**  
- [action.py](file://openhands/events/action/action.py#L114)
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py)

## 自定义插件开发指南

开发自定义插件需要遵循特定的接口定义和实现规范。

### 插件接口定义

自定义插件必须实现`Plugin`基类定义的接口，包括名称属性和必要的方法。

```mermaid
classDiagram
class Plugin {
<<abstract>>
+str name
+initialize(username : str)
+run(action : Action)
}
class PluginRequirement {
+str name
+str documentation
}
class CustomPlugin {
+str name
+initialize(username : str)
+run(action : Action)
}
Plugin <|-- CustomPlugin
PluginRequirement <.. CustomPlugin
```

**插件来源**  
- [requirement.py](file://openhands/runtime/plugins/requirement.py#L8-L24)

### 配置方法

插件通过配置文件或环境变量进行配置，确保灵活性和可管理性。

```mermaid
flowchart TD
A["创建插件类"] --> B["继承Plugin基类"]
B --> C["实现initialize方法"]
C --> D["实现run方法"]
D --> E["定义插件名称"]
E --> F["创建插件需求类"]
F --> G["注册到ALL_PLUGINS"]
G --> H["在配置中启用插件"]
H --> I["启动运行时"]
I --> J["插件自动加载"]
```

**插件来源**  
- [__init__.py](file://openhands/runtime/plugins/__init__.py#L21-L25)
- [requirement.py](file://openhands/runtime/plugins/requirement.py#L27-L32)

### 调试技巧

调试插件时可以使用日志记录和逐步初始化的方法来排查问题。

```mermaid
flowchart TD
A["启用调试日志"] --> B["设置LOG_LEVEL=DEBUG"]
B --> C["检查插件加载"]
C --> D["验证initialize方法"]
D --> E["测试run方法"]
E --> F["检查依赖关系"]
F --> G["验证配置参数"]
G --> H["使用单元测试"]
H --> I["逐步调试"]
I --> J["解决问题"]
```

**插件来源**  
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py#L301-L327)
- [logger.py](file://openhands/core/logger.py)