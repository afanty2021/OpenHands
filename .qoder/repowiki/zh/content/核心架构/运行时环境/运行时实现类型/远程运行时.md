# 远程运行时

<cite>
**本文档引用的文件**   
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [session.py](file://openhands/server/session/session.py)
- [remote.py](file://openhands/runtime/builder/remote.py)
- [ssh.md](file://microagents/ssh.md)
- [sandbox_config.py](file://openhands/core/config/sandbox_config.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障恢复策略](#故障恢复策略)
9. [安全配置](#安全配置)
10. [应用场景](#应用场景)

## 引言
远程运行时是OpenHands框架中的关键组件，它允许在分布式网络环境中执行任务。该系统通过SSH通信协议实现远程命令执行、文件同步和状态持久化，为开发者提供了一个强大的分布式开发环境。本文档将全面阐述远程运行时的执行架构、连接管理、会话保持以及网络故障恢复策略。

## 项目结构
远程运行时功能主要分布在以下几个目录中：
- `openhands/runtime/impl/remote/`：包含远程运行时的核心实现
- `microagents/`：包含SSH微代理等远程连接相关功能
- `openhands/server/session/`：处理会话管理和连接管理
- `openhands/core/config/`：包含运行时配置选项

```mermaid
graph TD
subgraph "核心组件"
RemoteRuntime[远程运行时]
ActionExecutionClient[动作执行客户端]
SessionManager[会话管理器]
end
subgraph "构建与部署"
RemoteRuntimeBuilder[远程运行时构建器]
Builder[构建器]
end
subgraph "配置"
SandboxConfig[沙箱配置]
SSHConfig[SSH配置]
end
RemoteRuntime --> ActionExecutionClient
RemoteRuntime --> SessionManager
RemoteRuntime --> RemoteRuntimeBuilder
RemoteRuntime --> SandboxConfig
RemoteRuntime --> SSHConfig
```

**Diagram sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [session.py](file://openhands/server/session/session.py)
- [remote.py](file://openhands/runtime/builder/remote.py)

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [session.py](file://openhands/server/session/session.py)

## 核心组件
远程运行时的核心组件包括远程运行时类、动作执行客户端、会话管理器和远程运行时构建器。这些组件协同工作，实现了跨网络环境的执行架构。

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [session.py](file://openhands/server/session/session.py)

## 架构概述
远程运行时采用客户端-服务器架构，通过HTTP/HTTPS协议与远程执行服务器通信。系统支持多种运行时类，包括sysbox和gvisor，提供了灵活的资源隔离选项。

```mermaid
graph TB
subgraph "客户端"
ClientApp[客户端应用]
RemoteRuntime[远程运行时]
end
subgraph "网络"
HTTP[HTTP/HTTPS协议]
end
subgraph "服务器"
ActionExecutionServer[动作执行服务器]
RemoteRuntimeClient[远程运行时客户端]
Container[容器环境]
end
ClientApp --> RemoteRuntime
RemoteRuntime --> HTTP
HTTP --> ActionExecutionServer
ActionExecutionServer --> RemoteRuntimeClient
RemoteRuntimeClient --> Container
```

**Diagram sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_server.py](file://openhands/runtime/action_execution_server.py)

## 详细组件分析

### 远程运行时分析
远程运行时组件负责管理与远程执行服务器的连接，处理命令执行、文件传输和状态管理。

#### 类图
```mermaid
classDiagram
class RemoteRuntime {
+config : OpenHandsConfig
+event_stream : EventStream
+llm_registry : LLMRegistry
+sid : str
+runtime_id : str | None
+runtime_url : str | None
+_runtime_initialized : bool
+runtime_builder : RemoteRuntimeBuilder
+container_image : str
+available_hosts : dict[str, int]
+main_module : str
+__init__(config, event_stream, llm_registry, sid, ...)
+connect() void
+_start_or_attach_to_runtime() void
+_check_existing_runtime() bool
+_build_runtime() void
+_start_runtime() void
+_resume_runtime() void
+_parse_runtime_response(response) void
+_wait_until_alive() void
+close() void
+_send_runtime_api_request(method, url, ...) httpx.Response
+_send_action_server_request(method, url, ...) httpx.Response
+_send_action_server_request_impl(method, url, ...) httpx.Response
+_stop_if_closed(retry_state) bool
+get_action_execution_server_startup_command() str
}
class ActionExecutionClient {
+session : HttpSession
+action_semaphore : threading.Semaphore
+_runtime_closed : bool
+_vscode_token : str | None
+_last_updated_mcp_stdio_servers : list[MCPStdioServerConfig]
+__init__(config, event_stream, llm_registry, sid, ...)
+action_execution_server_url() str
+_send_action_server_request(method, url, ...) httpx.Response
+check_if_alive() void
+list_files(path) list[str]
+copy_from(path) Path
+copy_to(host_src, sandbox_dest, recursive) void
+get_vscode_token() str
+send_action_for_execution(action) Observation
+run(action) Observation
+run_ipython(action) Observation
+read(action) Observation
+write(action) Observation
+edit(action) Observation
+browse(action) Observation
+browse_interactive(action) Observation
+get_mcp_config(extra_stdio_servers) MCPConfig
+call_tool_mcp(action) Observation
+close() void
}
class RemoteRuntimeBuilder {
+api_url : str
+api_key : str
+session : HttpSession
+__init__(api_url, api_key, session)
+build(path, tags, platform, extra_build_args) str
+image_exists(image_name, pull_from_repo) bool
}
RemoteRuntime --> ActionExecutionClient : "继承"
RemoteRuntime --> RemoteRuntimeBuilder : "使用"
```

**Diagram sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [remote.py](file://openhands/runtime/builder/remote.py)

### SSH微代理分析
SSH微代理提供了建立和管理SSH连接到远程机器的能力，支持密码和密钥认证等多种认证方法。

#### 流程图
```mermaid
flowchart TD
Start([SSH连接开始]) --> AuthenticationMethod{"认证方法?"}
AuthenticationMethod --> |密码认证| PasswordAuth["ssh username@hostname"]
AuthenticationMethod --> |密钥认证| KeyAuth["生成密钥对<br/>ssh-keygen -t ed25519"]
KeyAuth --> CopyKey["复制公钥到远程服务器<br/>ssh-copy-id -i ~/.ssh/key_name.pub username@hostname"]
CopyKey --> ConnectWithKey["使用私钥连接<br/>ssh -i ~/.ssh/key_name username@hostname"]
PasswordAuth --> EnterPassword["输入密码"]
EnterPassword --> Connected["连接成功"]
ConnectWithKey --> Connected
Connected --> ExecuteCommands["执行远程命令"]
ExecuteCommands --> TransferFiles["文件传输"]
TransferFiles --> ManageSSH["管理SSH配置和已知主机"]
ManageSSH --> End([SSH连接结束])
```

**Diagram sources**
- [ssh.md](file://microagents/ssh.md)

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [ssh.md](file://microagents/ssh.md)

## 依赖分析
远程运行时组件依赖于多个核心模块，包括事件流、LLM注册表、沙箱配置和HTTP会话管理。

```mermaid
graph TD
RemoteRuntime[远程运行时] --> ActionExecutionClient[动作执行客户端]
RemoteRuntime --> EventStream[事件流]
RemoteRuntime --> LLMRegistry[LLM注册表]
RemoteRuntime --> SandboxConfig[沙箱配置]
RemoteRuntime --> HttpSession[HTTP会话]
RemoteRuntime --> RemoteRuntimeBuilder[远程运行时构建器]
ActionExecutionClient --> EventStream
ActionExecutionClient --> LLMRegistry
ActionExecutionClient --> SandboxConfig
ActionExecutionClient --> HttpSession
RemoteRuntimeBuilder --> HttpSession
RemoteRuntimeBuilder --> SandboxConfig
```

**Diagram sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [remote.py](file://openhands/runtime/builder/remote.py)

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [action_execution_client.py](file://openhands/runtime/impl/action_execution/action_execution_client.py)
- [remote.py](file://openhands/runtime/builder/remote.py)

## 性能考虑
远程运行时的性能优化主要集中在以下几个方面：

### 网络延迟优化
- **连接重试机制**：使用指数退避算法进行连接重试，减少网络波动的影响
- **请求超时设置**：合理设置API请求超时时间，避免长时间等待
- **批量操作**：支持文件批量传输，减少网络往返次数

### 资源利用优化
- **资源因子配置**：通过`remote_runtime_resource_factor`参数调整远程运行时的资源分配
- **容器镜像缓存**：利用远程构建器的镜像存在检查功能，避免重复构建
- **会话复用**：支持连接到现有运行时实例，减少启动开销

### 配置参数
以下是一些关键的性能调优参数：

| 参数名称 | 默认值 | 描述 |
|--------|------|------|
| `remote_runtime_init_timeout` | 300秒 | 远程运行时初始化超时时间 |
| `remote_runtime_api_timeout` | 30秒 | 远程运行时API请求超时时间 |
| `remote_runtime_enable_retries` | True | 是否启用远程运行时请求重试 |
| `remote_runtime_resource_factor` | 1.0 | 远程运行时资源分配因子 |
| `client_wait_timeout` | 30秒 | 客户端等待超时时间 |

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [sandbox_config.py](file://openhands/core/config/sandbox_config.py)

## 故障恢复策略
远程运行时系统实现了多层次的故障恢复机制，确保在各种异常情况下能够保持服务的可用性。

### 连接管理
- **自动重连**：当检测到连接中断时，系统会自动尝试重新连接
- **会话保持**：即使客户端断开连接，运行时实例也可以保持活动状态，等待重新连接
- **超时处理**：设置了合理的超时机制，避免因网络问题导致的长时间阻塞

### 状态持久化
- **会话状态保存**：运行时状态信息被持久化存储，支持在故障后恢复
- **命令执行状态跟踪**：每个命令的执行状态都被记录，便于故障排查
- **错误日志记录**：详细的错误日志帮助快速定位和解决问题

### 恢复流程
```mermaid
flowchart TD
Start([系统启动]) --> CheckExistingRuntime["检查现有运行时"]
CheckExistingRuntime --> |存在| UseExistingRuntime["使用现有运行时"]
CheckExistingRuntime --> |不存在| StartNewRuntime["启动新运行时"]
StartNewRuntime --> BuildRuntime["构建运行时镜像"]
BuildRuntime --> StartRuntime["启动运行时"]
StartRuntime --> WaitAlive["等待运行时就绪"]
WaitAlive --> |就绪| RuntimeReady["运行时就绪"]
WaitAlive --> |未就绪| HandleError["处理错误"]
HandleError --> |可恢复| Retry["重试"]
HandleError --> |不可恢复| Fail["失败"]
UseExistingRuntime --> |运行中| RuntimeReady
UseExistingRuntime --> |已暂停| ResumeRuntime["恢复运行时"]
ResumeRuntime --> WaitAlive
UseExistingRuntime --> |已停止| StartNewRuntime
RuntimeReady --> End([系统就绪])
```

**Diagram sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [session.py](file://openhands/server/session/session.py)

## 安全配置
远程运行时系统提供了多种安全配置选项，确保在分布式环境中的安全执行。

### 认证与授权
- **API密钥认证**：使用API密钥进行身份验证，确保只有授权用户可以访问远程运行时
- **会话密钥**：为每个会话生成唯一的会话密钥，增强安全性
- **权限控制**：通过配置文件限制用户权限，防止越权操作

### SSH安全最佳实践
- **密钥权限管理**：确保私钥文件权限为600，公钥文件权限为644，SSH目录权限为700
- **禁用密码认证**：推荐使用密钥认证，禁用密码认证以提高安全性
- **定期轮换密钥**：定期更换SSH密钥，减少密钥泄露的风险

### 安全配置示例
```bash
# 设置正确的文件权限
chmod 600 ~/.ssh/id_ed25519
chmod 644 ~/.ssh/id_ed25519.pub
chmod 700 ~/.ssh

# SSH配置文件示例
Host alias
    HostName hostname_or_ip
    User username
    IdentityFile ~/.ssh/key_name
    Port 22
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

**Section sources**
- [ssh.md](file://microagents/ssh.md)
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)

## 应用场景
远程运行时在多种分布式开发环境中都有广泛的应用。

### 分布式评估
- **并行执行**：支持在云环境中并行执行评估任务，提高效率
- **资源隔离**：每个评估任务在独立的容器环境中运行，确保结果的可靠性
- **可扩展性**：可以根据需要动态调整计算资源，适应不同规模的评估需求

### 云开发环境
- **远程开发**：开发者可以在本地编辑代码，而在远程服务器上执行和调试
- **资源共享**：多个开发者可以共享高性能的远程计算资源
- **环境一致性**：确保开发、测试和生产环境的一致性

### 持续集成/持续部署
- **自动化测试**：在远程环境中执行自动化测试，确保代码质量
- **部署验证**：在部署前在远程环境中验证应用功能
- **性能测试**：利用远程高性能服务器进行压力测试和性能分析

**Section sources**
- [remote_runtime.py](file://openhands/runtime/impl/remote/remote_runtime.py)
- [ssh.md](file://microagents/ssh.md)